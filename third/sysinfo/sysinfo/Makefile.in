#
# $Revision: 1.2 $
#
# Makefile for building sysinfo main program
#

srcdir		= @srcdir@
topsrcdir 	= @top_srcdir@
VPATH 		= @srcdir@

prefix		= @prefix@
exec_prefix	= @exec_prefix@
BIN		= @bindir@
LIBEXECDIR	= @libexecdir@
CC		= @CC@
OPT		= @CFLAGS@

#
# The ${PROG} variable defines the name the sysinfo software is installed
# as.  If you want to install sysinfo to use a name other than "sysinfo"
# you should just need to change this value.
#
PROG		= sysinfo

@VarsMF@

#
# OS Specific makefile info
#
@OSNAMEmf@
@OSNAMEMVERmf@
@OSNAMEVERmf@

DEPLIBS		= ../lib/libmcsysinfo.a

#
# Make sure to put -lmcsysinfo first in the list as some loaders 
# resolve serially.
#
LIBS 		= -L../lib -lmcsysinfo $(OSLIBS) @LIBS@
INCLUDES	= -I../include -I$(srcdir)/include -I$(srcdir)/../include
DEFINES		= -DHAVE_AUTOCONFIG_H
CFLAGS 		= $(OPT) $(OSCFLAGS) $(INCLUDES) $(DEFINES)
LDFLAGS		= $(OPT) $(OSLDFLAGS)

BASE 		= sysinfo
Target		= $(O)$(BASE)

OBJS 		= \
		$(O)class.o \
		$(O)general.o \
		$(O)options.o \
		$(O)report.o \
		$(O)show.o \
		$(O)showdevices.o \
		$(O)showkernel.o \
		$(O)showpartition.o \
		$(O)showsoftinfo.o \
		$(O)showsysconf.o \
		$(O)sysinfo.o

#
# Main .h files
#
MCHFILES	= \
		../include/mcdefs.h \
		../include/mcl.h \
		../include/mconfig.h \
		../include/mcsysinfo.h \
		../include/mctypes.h \
		../include/options.h \
		../include/version.h

#
# SysInfo executable specific .h files
#
HFILES		= \
		include/declare.h \
		include/defs.h

all: ${Target}

FRC ${Target}: ${OBJS} buildinfo.o ${DEPLIBS}
	rm -f $@
	${CC} ${LDFLAGS} -o $@ ${OBJS} buildinfo.o ${LIBS}

buildinfo.c: $(OBJS)
	@$(MKVERSION) -file $@
#	@$(MKVERSION) -host magnicomp.com -user mcooper -file $@

mcdall: $(Target) sysinfowrapper.in
	RTPLATFORM=`$(BUILDINFO) -rtplatform -cfdir ${topsrcdir}/config`; \
	PLdir=libexec/platform/$${RTPLATFORM}; \
	$(MCDADD) -R $(PROTOROOT) $(INSTALLOPTS) -d $$PLdir \
		-t $$PLdir/sysinfo $(Target)
	$(MCDADD) -R $(PROTOROOT) -d $(PROTOBIN) $(INSTALLOWN) -m 555 \
		-t bin/sysinfo $(srcdir)/sysinfowrapper.in

install: $(Target) sysinfowrapper
	@$(MKDIRHIER) $(DESTDIR)$(BIN)
	@$(MKDIRHIER) $(DESTDIR)$(LIBEXECDIR)
	@if [ -z "$(DESTDIR)$(LIBEXECDIR)" ]; then \
		echo "The LIBEXECDIR variable is not set."; \
		exit 1; \
	fi; \
	RTPLATFORM=`$(BUILDINFO) -rtplatform -cfdir ${srcdir}/../config`; \
	PLdir=$(DESTDIR)$(LIBEXECDIR)/platform/$${RTPLATFORM}; \
	$(MKDIRHIER) $$PLdir; \
	if [ "$${RTPLATFORM}" = "linux-2-i686" ]; then \
		(cd $$PLdir/.. && rm -f linux-2-586 && \
		 ln -s $${RTPLATFORM} linux-2-i586); \
	fi; \
	echo $(INSTALLPROG) -c -m 555 $(INSTALLOWN) sysinfowrapper $(DESTDIR)$(BIN)/$(PROG); \
	$(INSTALLPROG) -c -m 555 $(INSTALLOWN) sysinfowrapper $(DESTDIR)$(BIN)/$(PROG); \
	echo $(INSTALLPROG) -c ${INSTALLOPTS} ${Target} $(DESTDIR)$$PLdir/${Target}; \
	$(INSTALLPROG) -s -c ${INSTALLOPTS} ${Target} $(DESTDIR)$$PLdir/${Target};

clean:
	rm -f *.o ${Target} buildinfo.c

distclean: clean
	rm -f Makefile sysinfowrapper
	rm -f *~ *% \#* core a.out sysinfo.tar sysinfo.tar.Z sysinfo.tar.gz

fullclean: distclean

FRC ${OBJS}: $(MCHFILES) $(HFILES)

test: all
	@echo "Running sysinfo as a test . . ."
	@echo "NOTE: You must be root to run this test successfully."
	./$(PROG) -cfdir ${topsrcdir}/config -level all

#
# For Q+A
#
output: $(Target)
	$(BUILD)/runtest ./$(Target) -cfdir ${topsrcdir}/config

FRC:
