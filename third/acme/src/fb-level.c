/* Generated by GOB (v2.0.3) on Thu Dec 19 22:14:54 2002
   (do not edit directly) */

/* End world hunger, donate to the World Food Programme, http://www.wfp.org */

#define GOB_VERSION_MAJOR 2
#define GOB_VERSION_MINOR 0
#define GOB_VERSION_PATCHLEVEL 3

#define selfp (self->_priv)


#line 1 "fb-level.gob"

#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/ioctl.h>
#include <linux/fb.h>
#include <linux/pmu.h>
#include <errno.h>
#include "fb-level.h"
#include "fb-level-private.h"

#ifndef FBIOBLANK
#define FBIOBLANK      0x4611          /* 0 or vesa-level+1 */
#endif

#ifndef PMU_IOC_GRAB_BACKLIGHT
#define PMU_IOC_GRAB_BACKLIGHT  _IOR('B', 6, 0)
#endif

#line 35 "fb-level.c"
/* self casting macros */
#define SELF(x) FB_LEVEL(x)
#define SELF_CONST(x) FB_LEVEL_CONST(x)
#define IS_SELF(x) FB_IS_LEVEL(x)
#define TYPE_SELF FB_TYPE_LEVEL
#define SELF_CLASS(x) FB_LEVEL_CLASS(x)

#define SELF_GET_CLASS(x) FB_LEVEL_GET_CLASS(x)

/* self typedefs */
typedef FBLevel Self;
typedef FBLevelClass SelfClass;

/* here are local prototypes */
static void ___object_set_property (GObject *object, guint property_id, const GValue *value, GParamSpec *pspec);
static void ___object_get_property (GObject *object, guint property_id, GValue *value, GParamSpec *pspec);
static void fb_level_init (FBLevel * o) G_GNUC_UNUSED;
static void fb_level_class_init (FBLevelClass * c) G_GNUC_UNUSED;
static int fb_level_level_check (int level) G_GNUC_UNUSED;

enum {
	PROP_0,
	PROP_LEVEL,
	PROP_DIM
};

/* pointer to the class of our parent */
static GObjectClass *parent_class = NULL;

/* Short form macros */
#if defined(__GNUC__) && !defined(__STRICT_ANSI__)
#define self_get_level(args...) fb_level_get_level(args)
#define self_set_level(args...) fb_level_set_level(args)
#define self_get_dim(args...) fb_level_get_dim(args)
#define self_set_dim(args...) fb_level_set_dim(args)
#define self_new() fb_level_new()
#define self_level_check(args...) fb_level_level_check(args)
#define self_is_powerbook() fb_level_is_powerbook()
#endif /* __GNUC__ && !__STRICT_ANSI__ */

/* Short form pointers */
static gint (* const self_get_level) (FBLevel * self) = fb_level_get_level;
static void (* const self_set_level) (FBLevel * self, gint val) = fb_level_set_level;
static gboolean (* const self_get_dim) (FBLevel * self) = fb_level_get_dim;
static void (* const self_set_dim) (FBLevel * self, gboolean val) = fb_level_set_dim;
static FBLevel * (* const self_new) (void) = fb_level_new;
static int (* const self_level_check) (int level) = fb_level_level_check;
static gboolean (* const self_is_powerbook) (void) = fb_level_is_powerbook;

GType
fb_level_get_type (void)
{
	static GType type = 0;

	if (type == 0) {
		static const GTypeInfo info = {
			sizeof (FBLevelClass),
			(GBaseInitFunc) NULL,
			(GBaseFinalizeFunc) NULL,
			(GClassInitFunc) fb_level_class_init,
			(GClassFinalizeFunc) NULL,
			NULL /* class_data */,
			sizeof (FBLevel),
			0 /* n_preallocs */,
			(GInstanceInitFunc) fb_level_init,
		};

		type = g_type_register_static (G_TYPE_OBJECT, "FBLevel", &info, (GTypeFlags)0);
	}

	return type;
}

/* a macro for creating a new object of our type */
#define GET_NEW ((FBLevel *)g_object_new(fb_level_get_type(), NULL))

/* a function for creating a new object of our type */
#include <stdarg.h>
static FBLevel * GET_NEW_VARG (const char *first, ...) G_GNUC_UNUSED;
static FBLevel *
GET_NEW_VARG (const char *first, ...)
{
	FBLevel *ret;
	va_list ap;
	va_start (ap, first);
	ret = (FBLevel *)g_object_new_valist (fb_level_get_type (), first, ap);
	va_end (ap);
	return ret;
}


static void
___finalize(GObject *obj_self)
{
#define __GOB_FUNCTION__ "FB:Level::finalize"
	FBLevel *self = FB_LEVEL (obj_self);
	gpointer priv = self->_priv;
	if(G_OBJECT_CLASS(parent_class)->finalize) \
		(* G_OBJECT_CLASS(parent_class)->finalize)(obj_self);
	g_free (priv);
	return;
	self = NULL;
}
#undef __GOB_FUNCTION__

static void 
fb_level_init (FBLevel * o)
{
#define __GOB_FUNCTION__ "FB:Level::init"
	o->_priv = g_new0 (FBLevelPrivate, 1);
#line 1 "fb-level.gob"
	o->level = 0;
#line 148 "fb-level.c"
#line 35 "fb-level.gob"
	o->dim = FALSE;
#line 151 "fb-level.c"
#line 75 "fb-level.gob"
	o->_priv->pmu_fd = -1;
#line 154 "fb-level.c"
#line 75 "fb-level.gob"
	o->_priv->saved_level = 0;
#line 157 "fb-level.c"
	return;
	o = NULL;
}
#undef __GOB_FUNCTION__
static void 
fb_level_class_init (FBLevelClass * c)
{
#define __GOB_FUNCTION__ "FB:Level::class_init"
	GObjectClass *g_object_class = (GObjectClass*) c;

	parent_class = g_type_class_ref (G_TYPE_OBJECT);

	g_object_class->finalize = ___finalize;
	g_object_class->get_property = ___object_get_property;
	g_object_class->set_property = ___object_set_property;
    {
	GParamSpec   *param_spec;

	param_spec = g_param_spec_int ("level", NULL, NULL,
		G_MININT, G_MAXINT,
		0,
		(GParamFlags)(G_PARAM_READABLE | G_PARAM_WRITABLE));
	g_object_class_install_property (g_object_class,
		PROP_LEVEL, param_spec);
	param_spec = g_param_spec_int ("dim", NULL, NULL,
		G_MININT, G_MAXINT,
		0,
		(GParamFlags)(G_PARAM_READABLE | G_PARAM_WRITABLE));
	g_object_class_install_property (g_object_class,
		PROP_DIM, param_spec);
    }
	return;
	c = NULL;
	g_object_class = NULL;
}
#undef __GOB_FUNCTION__

static void
___object_set_property (GObject *object,
	guint property_id,
	const GValue *VAL,
	GParamSpec *pspec)
#define __GOB_FUNCTION__ "FB:Level::set_property"
{
	FBLevel *self;

	self = FB_LEVEL (object);

	switch (property_id) {
	case PROP_LEVEL:
	{	gint  ARG = (gint ) g_value_get_int (VAL);
		{
#line 35 "fb-level.gob"

		int level;

		level = fb_level_level_check(ARG);

		ioctl (self->_priv->pmu_fd,
				PMU_IOC_SET_BACKLIGHT, &level);
		self->level = level;
	
#line 220 "fb-level.c"
		}
		if (&ARG) ;
		break;
	}
	case PROP_DIM:
	{	gboolean  ARG = (gboolean ) g_value_get_int (VAL);
		{
#line 52 "fb-level.gob"

		if (self->dim == FALSE && ARG == TRUE)
		{
			self->_priv->saved_level =
				fb_level_get_level(self);
			fb_level_set_level (self, 1);
			self->dim = TRUE;
		} else if (self->dim == TRUE && ARG == FALSE) {
			fb_level_set_level (self, self->_priv->saved_level);
			self->dim = FALSE;
		}
	
#line 241 "fb-level.c"
		}
		if (&ARG) ;
		break;
	}
	default:
/* Apparently in g++ this is needed, glib is b0rk */
#ifndef __PRETTY_FUNCTION__
#  undef G_STRLOC
#  define G_STRLOC	__FILE__ ":" G_STRINGIFY (__LINE__)
#endif
		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, property_id, pspec);
		break;
	}
	return;
	self = NULL;
	VAL = NULL;
	pspec = NULL;
}
#undef __GOB_FUNCTION__

static void
___object_get_property (GObject *object,
	guint property_id,
	GValue *VAL,
	GParamSpec *pspec)
#define __GOB_FUNCTION__ "FB:Level::get_property"
{
	FBLevel *self;

	self = FB_LEVEL (object);

	switch (property_id) {
	case PROP_LEVEL:
	{	gint  ARG;
	memset (&ARG, 0, sizeof (gint ));
		{
#line 26 "fb-level.gob"

		int level;

		ioctl (self->_priv->pmu_fd,
				PMU_IOC_GET_BACKLIGHT, &level);

		ARG = level;
	
#line 287 "fb-level.c"
		}
		g_value_set_int (VAL, ARG);
		break;
	}
	case PROP_DIM:
	{	gboolean  ARG;
	memset (&ARG, 0, sizeof (gboolean ));
		{
#line 48 "fb-level.gob"

		ARG = self->dim;
	
#line 300 "fb-level.c"
		}
		g_value_set_int (VAL, ARG);
		break;
	}
	default:
/* Apparently in g++ this is needed, glib is b0rk */
#ifndef __PRETTY_FUNCTION__
#  undef G_STRLOC
#  define G_STRLOC	__FILE__ ":" G_STRINGIFY (__LINE__)
#endif
		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, property_id, pspec);
		break;
	}
	return;
	self = NULL;
	VAL = NULL;
	pspec = NULL;
}
#undef __GOB_FUNCTION__



#line 26 "fb-level.gob"
gint 
fb_level_get_level (FBLevel * self)
#line 326 "fb-level.c"
{
#define __GOB_FUNCTION__ "FB:Level::get_level"
{
#line 25 "fb-level.gob"
		gint val; g_object_get (G_OBJECT (self), "level", &val, NULL); return val;
}}
#line 333 "fb-level.c"
#undef __GOB_FUNCTION__

#line 35 "fb-level.gob"
void 
fb_level_set_level (FBLevel * self, gint val)
#line 339 "fb-level.c"
{
#define __GOB_FUNCTION__ "FB:Level::set_level"
{
#line 25 "fb-level.gob"
		g_object_set (G_OBJECT (self), "level", val, NULL);
}}
#line 346 "fb-level.c"
#undef __GOB_FUNCTION__

#line 48 "fb-level.gob"
gboolean 
fb_level_get_dim (FBLevel * self)
#line 352 "fb-level.c"
{
#define __GOB_FUNCTION__ "FB:Level::get_dim"
{
#line 47 "fb-level.gob"
		gboolean val; g_object_get (G_OBJECT (self), "dim", &val, NULL); return val;
}}
#line 359 "fb-level.c"
#undef __GOB_FUNCTION__

#line 52 "fb-level.gob"
void 
fb_level_set_dim (FBLevel * self, gboolean val)
#line 365 "fb-level.c"
{
#define __GOB_FUNCTION__ "FB:Level::set_dim"
{
#line 47 "fb-level.gob"
		g_object_set (G_OBJECT (self), "dim", val, NULL);
}}
#line 372 "fb-level.c"
#undef __GOB_FUNCTION__

/**
 * fb_level_new:
 *
 * Creates a new #FBLevel object
 *
 * Returns: a new object
 **/
#line 72 "fb-level.gob"
FBLevel * 
fb_level_new (void)
#line 385 "fb-level.c"
{
#define __GOB_FUNCTION__ "FB:Level::new"
{
#line 75 "fb-level.gob"
	
		FBLevel *self;
		int fd, foo;

		if (g_file_test ("/dev/pmu", G_FILE_TEST_EXISTS) == FALSE)
			return NULL;

		if (fb_level_is_powerbook () == FALSE)
			return NULL;

		self = (FBLevel *)GET_NEW;
		/* This function switches the kernel backlight control off.
		 * This is part of the PPC kernel branch since version
		 * 2.4.18-rc2-benh. It does nothing with older kernels.
		 * For those kernels a separate kernel patch is nessecary to
		 * get backlight control in user space.
		 *
		 * Notice nicked from pbbuttons*/
		fd  = open ("/dev/pmu", O_RDWR);
		/* We can't emit the signal yet, the signal isn't connected! */
		if (fd < 0)
			return NULL;

		foo = ioctl(fd, PMU_IOC_GRAB_BACKLIGHT, 0);
		self->_priv->pmu_fd = fd;
		return self;
	}}
#line 417 "fb-level.c"
#undef __GOB_FUNCTION__

#line 111 "fb-level.gob"
static int 
fb_level_level_check (int level)
#line 423 "fb-level.c"
{
#define __GOB_FUNCTION__ "FB:Level::level_check"
{
#line 114 "fb-level.gob"
	
		return CLAMP (level, 0, 15);
	}}
#line 431 "fb-level.c"
#undef __GOB_FUNCTION__

#line 118 "fb-level.gob"
gboolean 
fb_level_is_powerbook (void)
#line 437 "fb-level.c"
{
#define __GOB_FUNCTION__ "FB:Level::is_powerbook"
{
#line 121 "fb-level.gob"
	
		FILE *fd;
		char str[2048];
		gboolean found = FALSE;

		fd = fopen ("/proc/cpuinfo", "r");
		while (!feof (fd) && found == FALSE)
		{
			fread (str, 1, 2048, fd);
			if (strstr (str, "PowerBook") != NULL)
				found = TRUE;
		}

		fclose (fd);

		return found;
	}}
#line 459 "fb-level.c"
#undef __GOB_FUNCTION__


#if (!defined __GNUC__) || (defined __GNUC__ && defined __STRICT_ANSI__)
/*REALLY BAD HACK
  This is to avoid unused warnings if you don't call
  some method.  I need to find a better way to do
  this, not needed in GCC since we use some gcc
  extentions to make saner, faster code */
static void
___fb_level_really_bad_hack_to_avoid_warnings(void)
{
	((void (*)(void))GET_NEW_VARG)();
	((void (*)(void))self_get_level)();
	((void (*)(void))self_set_level)();
	((void (*)(void))self_get_dim)();
	((void (*)(void))self_set_dim)();
	((void (*)(void))self_new)();
	((void (*)(void))self_level_check)();
	((void (*)(void))self_is_powerbook)();
	___fb_level_really_bad_hack_to_avoid_warnings();
}
#endif /* !__GNUC__ || (__GNUC__ && __STRICT_ANSI__) */

