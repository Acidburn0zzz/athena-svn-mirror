<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libdaemon: Example Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6-20040222 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>testd.c</h1>This is an example for the usage of libdaemon <div class="fragment"><pre><span class="comment">/* $Id: testd_8c-example.html,v 1.1.1.1 2004-04-09 20:08:49 amb Exp $ */</span>

<span class="comment">/*</span>
<span class="comment"> * This file is part of libdaemon.</span>
<span class="comment"> *</span>
<span class="comment"> * libdaemon is free software; you can redistribute it and/or modify it</span>
<span class="comment"> * under the terms of the GNU General Public License as published by</span>
<span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="comment"> * (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * libdaemon is distributed in the hope that it will be useful, but</span>
<span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="comment"> * General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License</span>
<span class="comment"> * along with libdaemon; if not, write to the Free Software Foundation,</span>
<span class="comment"> * Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;signal.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="dfork_8h.html">dfork.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="dsignal_8h.html">dsignal.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="dlog_8h.html">dlog.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="dpid_8h.html">dpid.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="dexec_8h.html">dexec.h</a>&gt;</span>

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {
    pid_t pid;

    <span class="comment">/* Set indetification string for the daemon for both syslog and PID file */</span>
    <a class="code" href="dpid_8h.html#a2">daemon_pid_file_ident</a> = <a class="code" href="dlog_8h.html#a1">daemon_log_ident</a> = <a name="a0"></a><a class="code" href="dlog_8h.html#a7">daemon_ident_from_argv0</a>(argv[0]);

    <span class="comment">/* Check if we are called with -k parameter */</span>
    <span class="keywordflow">if</span> (argc &gt;= 2 &amp;&amp; !strcmp(argv[1], <span class="stringliteral">"-k"</span>)) {
        <span class="keywordtype">int</span> ret;

        <span class="comment">/* Kill daemon with SIGINT */</span>
        
        <span class="comment">/* Check if the new function daemon_pid_file_kill_wait() is available, if it is, use it. */</span>
<span class="preprocessor">#ifdef DAEMON_PID_FILE_KILL_WAIT_AVAILABLE        </span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ((ret = <a name="a1"></a><a class="code" href="dpid_8h.html#a9">daemon_pid_file_kill_wait</a>(SIGINT, 5)) &lt; 0)
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ((ret = <a name="a2"></a><a class="code" href="dpid_8h.html#a8">daemon_pid_file_kill</a>(SIGINT)) &lt; 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            <a name="a3"></a><a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_WARNING, <span class="stringliteral">"Failed to kill daemon"</span>);
        
        <span class="keywordflow">return</span> ret &lt; 0 ? 1 : 0;
    }

    <span class="comment">/* Check that the daemon is not rung twice a the same time */</span>
    <span class="keywordflow">if</span> ((pid = <a name="a4"></a><a class="code" href="dpid_8h.html#a7">daemon_pid_file_is_running</a>()) &gt;= 0) {
        <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_ERR, <span class="stringliteral">"Daemon already running on PID file %u"</span>, pid);
        <span class="keywordflow">return</span> 1;
        
    }

    <span class="comment">/* Prepare for return value passing from the initialization procedure of the daemon process */</span>
    <a name="a5"></a><a class="code" href="dfork_8h.html#a1">daemon_retval_init</a>();

    <span class="comment">/* Do the fork */</span>
    <span class="keywordflow">if</span> ((pid = <a name="a6"></a><a class="code" href="dfork_8h.html#a0">daemon_fork</a>()) &lt; 0) {

        <span class="comment">/* Exit on error */</span>
        <a name="a7"></a><a class="code" href="dfork_8h.html#a2">daemon_retval_done</a>();
        <span class="keywordflow">return</span> 1;
        
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid) { <span class="comment">/* The parent */</span>
        <span class="keywordtype">int</span> ret;

        <span class="comment">/* Wait for 20 seconds for the return value passed from the daemon process */</span>
        <span class="keywordflow">if</span> ((ret = <a name="a8"></a><a class="code" href="dfork_8h.html#a3">daemon_retval_wait</a>(20)) &lt; 0) {
            <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_ERR, <span class="stringliteral">"Could not recieve return value from daemon process."</span>);
            <span class="keywordflow">return</span> 255;
        }

        <a class="code" href="dlog_8h.html#a6">daemon_log</a>(ret != 0 ? LOG_ERR : LOG_INFO, <span class="stringliteral">"Daemon returned %i as return value."</span>, ret);
        <span class="keywordflow">return</span> ret;
        
    } <span class="keywordflow">else</span> { <span class="comment">/* The daemon */</span>
        <span class="keywordtype">int</span> fd, quit = 0;
        fd_set fds;

        <span class="comment">/* Create the PID file */</span>
        <span class="keywordflow">if</span> (<a name="a9"></a><a class="code" href="dpid_8h.html#a5">daemon_pid_file_create</a>() &lt; 0) {
            <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_ERR, <span class="stringliteral">"Could not create PID file (%s)."</span>, strerror(errno));

            <span class="comment">/* Send the error condition to the parent process */</span>
            <a name="a10"></a><a class="code" href="dfork_8h.html#a4">daemon_retval_send</a>(1);
            <span class="keywordflow">goto</span> finish;
        }

        <span class="comment">/* Initialize signal handling */</span>
        <span class="keywordflow">if</span> (<a name="a11"></a><a class="code" href="dsignal_8h.html#a0">daemon_signal_init</a>(SIGINT, SIGQUIT, SIGHUP, 0) &lt; 0) {
            <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_ERR, <span class="stringliteral">"Could not register signal handlers (%s)."</span>, strerror(errno));
            <a class="code" href="dfork_8h.html#a4">daemon_retval_send</a>(2);
            <span class="keywordflow">goto</span> finish;
        }
        
        <span class="comment">/*... do some further init work here */</span>


        <span class="comment">/* Send OK to parent process */</span>
        <a class="code" href="dfork_8h.html#a4">daemon_retval_send</a>(0);

        <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_INFO, <span class="stringliteral">"Sucessfully started"</span>);


        <span class="comment">/* Prepare for select() on the signal fd */</span>
        FD_ZERO(&amp;fds);
        FD_SET(fd = <a name="a12"></a><a class="code" href="dsignal_8h.html#a4">daemon_signal_fd</a>(), &amp;fds);
        
        <span class="keywordflow">while</span> (!quit) {
            fd_set fds2 = fds;

            <span class="comment">/* Wait for an incoming signal */</span>
            <span class="keywordflow">if</span> (select(FD_SETSIZE, &amp;fds2, 0, 0, 0) &lt; 0) {

                <span class="comment">/* If we've been interrupted by an incoming signal, continue */</span>
                <span class="keywordflow">if</span> (errno == EINTR)
                    <span class="keywordflow">continue</span>;
                
                <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_ERR, <span class="stringliteral">"select(): %s"</span>, strerror(errno));
                <span class="keywordflow">break</span>;
            }

            <span class="comment">/* Check if a signal has been recieved */</span>
            <span class="keywordflow">if</span> (FD_ISSET(fd, &amp;fds)) {
                <span class="keywordtype">int</span> sig;

                <span class="comment">/* Get signal */</span>
                <span class="keywordflow">if</span> ((sig = <a name="a13"></a><a class="code" href="dsignal_8h.html#a3">daemon_signal_next</a>()) &lt;= 0) {
                    <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_ERR, <span class="stringliteral">"daemon_signal_next() failed."</span>);
                    <span class="keywordflow">break</span>;
                }

                <span class="comment">/* Dispatch signal */</span>
                <span class="keywordflow">switch</span> (sig) {

                    <span class="keywordflow">case</span> SIGINT:
                    <span class="keywordflow">case</span> SIGQUIT:
                        <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_WARNING, <span class="stringliteral">"Got SIGINT or SIGQUIT"</span>);
                        quit = 1;
                        <span class="keywordflow">break</span>;

                    <span class="keywordflow">case</span> SIGHUP:
                        <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_INFO, <span class="stringliteral">"Got a HUP"</span>);
                        <a name="a14"></a><a class="code" href="dexec_8h.html#a1">daemon_exec</a>(<span class="stringliteral">"/"</span>, NULL, <span class="stringliteral">"/bin/ls"</span>, <span class="stringliteral">"ls"</span>, (<span class="keywordtype">char</span>*) NULL);
                        <span class="keywordflow">break</span>;

                }
            }
        }

        <span class="comment">/* Do a cleanup */</span>
finish:
        <a class="code" href="dlog_8h.html#a6">daemon_log</a>(LOG_INFO, <span class="stringliteral">"Exiting..."</span>);

        <a name="a15"></a><a class="code" href="dsignal_8h.html#a2">daemon_signal_done</a>();
        <a name="a16"></a><a class="code" href="dpid_8h.html#a6">daemon_pid_file_remove</a>();
        
        <span class="keywordflow">return</span> 0;
    }
}
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Wed Apr 7 19:54:39 2004 for libdaemon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6-20040222 </small></address>
</body>
</html>
