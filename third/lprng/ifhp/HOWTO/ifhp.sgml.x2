<!-- ifhp-HOWTO SGML format -->
<!doctype linuxdoc system>
<article>
<!-- must be matched by / article at end -->
<!-- $Id: ifhp.sgml.x2,v 1.1.1.1 1999-05-04 18:51:16 mwhitson Exp $ -->
<title> IFHP-HOWTO
<author> Patrick Powell
<tt><htmlurl url="mailto:papowell@astart.com" name="papowell@astart.com"></tt>
<date> 17 Apr 1999 (For ifhp-3.2.5)
<abstract>
The <tt>ifhp</tt> software is an enhanced, extended, highly configurable,
and portable implementation of a print filter for use with the <tt>ifhp</tt>
Print spooler software.
It supports network, serial, and parallel printers,
does page accounting and job recovery,
and allows an extremely high level of configuration and tuning.
The <tt>ifhp</tt> filter gets its flexibility by using a configuration file
to set its operational characteristics.  The configuration file can contain
multiple separate printer configurations,  and the desired one can be
selected by a simple mechanism.
The filter can support vintage text,  PostScript,
PCL, and PJL printers, and can be configured to handle a wide range of
printer quirks and misimplementations.
</abstract>
<toc>
<sect>Introduction
<p>
The <tt>ifhp</tt> print filter is the latest in a long evolutionary path
of print filters for the <tt>ifhp</tt> printing system.
It is intended to unify several different methods of controlling
printers,  and provide a common code base for future development.
<p>
This document is the complete set of references and
installation guide for the <tt>ifhp</tt> printer.
It covers the compilation and installation,
initial testing,
details of system configuration,
and various configuration options that would be needed by the
system administrator.
<p>
The reference for Printer Job Language (PJL) related issues
was the Printer Job Language Technical Reference Manual,
Hewlett Packard, 10th Edition, October 1997,
and the reference for PCL related issues was
the PCL 5 Printer Language Technical Reference Manual,
First Edition, 1992.
These manuals are available through the Hewlett Packard Developers Program.
See
<htmlurl url="http://www.hp.com/go/devexchange"
name="http://www.hp.com/go/devexchange">
for information on how to join.
<p>
Previous releases of <tt>ifhp</tt> had a large selection of
<tt/README/
files
which are now incorporated into the <tt>ifhp</tt>-HOWTO document.
<p>
Current information
about LPRng, <tt>ifhp</tt> and the latest release can be found on the LPRng web page:
<p>
<htmlurl url="http://www.astart.com/LPRng.html" name="http://www.astart.com/LPRng.html">
<p>
There is also a mailing list at <tt>lprng@iona.com</tt>. To subscribe,
send an email to <tt>lprng-request@iona.com</tt>. The body should contain
only the word `subscribe'. To get off the list later on, repeat the
same procedure, but use the word `unsubscribe'.
<p>
Several presentations of LPRng and print spooling software have been made
at the Large Scale Installation Administrator (LISA) conferences and
are in the <tt>ifhp</tt> distribution and available on web sites.
<htmlurl url="ftp://ftp.astart.com/pub/LPRng/LPRngLISA95.ps" name="<tt>ifhp</tt> - An Enhanced Printer Spooler System">
was presented at the LISA95 conference,
and is in the LPRng distribution as LPRng-LISA95.ps.
On a more general topic,
the slides for the LISA97 tutorial on
<htmlurl url="ftp://ftp.astart.com/pub/LPRng/LISA97.tgz" name="Printers and Network Print Spooling">
are also in the LPRng distribution in the DOC/LISA97 directory.
<p>
<sect1>Copyright
<p>
Material included in this document from the <tt>ifhp</tt> distribution
Copyright Patrick Powell 1988-1999, where applicable.
<p>
The rights to distribute this document complete or in part are hereby
granted for non-commercial purposes. Partial reproductions must
acknowledge the source.
<p>
Permission to distribute this file together with LPRng and `derived
works' (as defined in the LPRng license) is explicitly granted. This
is allowed independent of the license under which the software is
distributed.
<p>
Citing the document is allowed as long as the source is acknowledged.
<sect1>Disclaimer
<p>
<bf>THE MATERIAL IN THIS HOWTO IS PROVIDED WITHOUT FEE AND AS-IS WITH NO
WARRANTY REGARDING FITNESS OF USE FOR ANY PURPOSE. THE AUTHOR AND ALL
CONTRIBUTORS ARE NOT LIABLE FOR ANY DAMAGES, DIRECT OR INDIRECT,
RESULTING FROM THE USE OF INFORMATION PROVIDED IN THIS DOCUMENT.</bf>
<sect1>Commercial Support
<p>
<htmlurl url="http://www.astart.com" name="AStArt Technologies">
provides commercial support and enhancements for
LPRng, <tt>ifhp</tt>, and other network software.
AStArt provides network and system consulting services for UNIX and NT
systems, as well as real time and network software.
<sect1>Web Site
<p>
Web Page:
<p>
<htmlurl url="http://www.astart.com/lprng.html" name="http://www.astart.com/lprng.html">
<label id="secftp">
<sect1>FTP Sites
<p>
The software may be obtained from <newline>
<htmlurl url="ftp://ftp.astart.com/pub/LPRng/FILTERS" name="ftp://ftp.astart.com/pub/LPRng/FILTERS">(Main site)
<newline>
<p>
Mirrors:<newline>
<htmlurl url="ftp://ftp.sage-au.org.au/pub/printing/spooler/lprng" name="ftp://ftp.sage-au.org.au/pub/printing/spooler/lprng"> (AU)<newline>
<htmlurl url="ftp://ftp.zod.wau.nl/pub/mirror/plp/LPRng" name="ftp://ftp.zod.wau.nl/pub/mirror/plp/LPRng"> (AU/NZ)<newline>
<htmlurl url="ftp://gwynne.cs.ualberta.ca/pub/LPRng" name="ftp://gwynne.cs.ualberta.ca/pub/LPRng"> (CA)<newline>
<htmlurl url="ftp://ftp.informatik.uni-hamburg.de/pub/os/unix/utils/LPRng" name="ftp://ftp.informatik.uni-hamburg.de/pub/os/unix/utils/LPRng"> (DE)<newline>
<htmlurl url="ftp://ftp.uni-paderborn.de/pub/unix/printer/plp/LPRng" name="ftp://ftp.uni-paderborn.de/pub/unix/printer/plp/LPRng"> (DE)<newline>
<htmlurl url="ftp://ftp.iona.ie/pub/plp/LPRng" name="ftp://ftp.iona.ie/pub/plp/LPRng"> (IE)<newline>
<htmlurl url="ftp://ftp.chembio.ntnu.no/pub/mirrors/LPRng" name="ftp://ftp.chembio.ntnu.no/pub/mirrors/LPRng"> (NO)<newline>
<htmlurl url="ftp://ftp.mono.org/pub/LPRng" name="ftp://ftp.mono.org/pub/LPRng"> (UK)<newline>
<htmlurl url="ftp://ftp.cs.columbia.edu/pub/archives/pkg/LPRng" name="ftp://ftp.cs.columbia.edu/pub/archives/pkg/LPRng"> (US)<newline>
<htmlurl url="ftp://ftp.cs.umn.edu/pub/LPRng" name="ftp://ftp.cs.umn.edu/pub/LPRng"> (US)<newline>
<htmlurl url="ftp://ftp.iona.com/pub/plp/LPRng" name="ftp://ftp.iona.com/pub/plp/LPRng"> (US)<newline>
<htmlurl url="ftp://uiarchive.uiuc.edu/pub/packages/LPRng" name="ftp://uiarchive.uiuc.edu/pub/packages/LPRng"> (US)<newline>
<sect1>Mailing List
<p>
To join the LPRng mailing list, please send mail to
<htmlurl url="mailto: lprng-request@iona.ie" name="lprng-request@iona.ie"> with the word 'subscribe' in the BODY
<label id="faqref">
<sect1>PGP Public Key
<p>
The LPRng and <tt>ifhp</tt> distributions have an MD5 checksum calculated,
which is then signed with a PGP public key.
Here is the key for validating the checksums:
<tscreen>
<verb>
Type Bits/KeyID    Date       User ID
pub  1024/00D95C9D 1997/01/31 Patrick A. Powell <papowell@astart.com>
							  Patrick A. Powell <papowell@sdsu.edu>

-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: 2.6.3i

mQCNAzLygTQAAAEEANBW5fPYjN3wSAnP9xWOUc3CvsMUxjip0cN2sY5qrdoJyIhn
qbAspBopR+tGQfyp5T7C21yfWRRnfXmoJ3FVtgToAsJUYmzoSFY08eDx+rmSqCLe
rdJjX8aG8jVXpGipEo9U4QsUK+OKzx3/y/OaK4cizoWqKvy1l4lEzDsA2VydAAUT
tCdQYXRyaWNrIEEuIFBvd2VsbCA8cGFwb3dlbGxAYXN0YXJ0LmNvbT6JAJUDBRA0
XonoiUTMOwDZXJ0BAQ2cBAC7zU9Fn3sC3x0USJ+3vjhg/qA+Gjb5Fi1dJd4solc4
vJvtf0UL/1/rGipbR+A0XHpHzJUMP9ZfJzKZjaK/d0ZBNlS3i+JnypypeQiAqo9t
FV0OyUCwDfWybgAORuAa2V6UJnAhvj/7TpxMmCApolaIb4yFyKunHa8aBxN+17Ro
rrQlUGF0cmljayBBLiBQb3dlbGwgPHBhcG93ZWxsQHNkc3UuZWR1PokAlQMFEDLy
gTSJRMw7ANlcnQEBYBYD/0zTeoiDNnI+NjaIei6+6z6oakqO70qFVx0FG3aP3kRH
WlDhdtFaAuaMRh+RItHfFfcHhw5K7jiJdgKiTgGfj5Vt3OdHYkeeh/sddqgf9YnS
tpj0u5NfrotPTUw39n6YTgS5/aW0PQfO9dx7jVUcGeod1TGXTe9mIhDMwDJI4J14
=3Zbp
-----END PGP PUBLIC KEY BLOCK-----
</verb>
</tscreen>
<sect>Installation and Express Configuration
<p>
Before you do an installation,
you should read the following instructions.
You will need to:
<enum>
<item>
   Use GNU Make.  Don't even think about trying to use another
     make unless you are a Wizard.  And even the Wizards would
     download the GNU Make.
<item>
   Use an ANSI C compiler.
<item>
   Read the <tt>HOWTO/ifhp-HOWTO.{ps,html,text,...}</tt>
      file(s).
You are doing this now, so you are off to a good start.
<item>
Generate the executables.
<item>
Install the configuration files.
<item>
Run some simple standalone tests,
i.e. - without using the print spooler.
<item>
Modify the configuration files to suit your sites requirements.
<item>
Install the executables.
<item>
Modify the printcap files and/or add other information to the printcap files.
<item>
Try the <tt>ifhp</tt> filter with the working print spooler.
</enum>
<p>
In addition, you might want to get the following software,
which can be used with
<tt/ifhp/.
<descrip>
<tag>a2ps - Ascii Text To PostScript Converter</tag>
<htmlurl url="http://www-inf.enst.fr/~demaille/a2ps/"
name="http://www-inf.enst.fr/~demaille/a2ps/" >
This package does a very good job of text to PostScript conversion.
<tag>enscript - GNU Enscript</tag>
<htmlurl url="http://www.gnu.org"
name="http://www.gnu.org/" >
This package is a simpler version of a2ps,
and is faster and smaller.
<tag>Unix File Utility - Determines the type of file</tag>
<htmlurl url="ftp://ftp.astron.com/pub/file/"
name="ftp://ftp.astron.com/pub/file/"> or
<htmlurl url="ftp://ftp.deshaw.com/pub/file/"
name="ftp://ftp.deshaw.com/pub/file/">.
<tag>LPRng Print Spooler</tag>
<htmlurl url="http://www.astart.com"
name="http://www.astart.com" >
</descrip>
<sect1> Configure and Compilation
<p>
The <tt>ifhp</tt> filter uses the AUTOCONF configuration facilty.
The following set of commands will generate configuration files
and compile and install the software and documentation.
<p>
It is highly unlikely that you will encounter problems with compilation.
Usually these are due to type definition conflicts in include files.
If you encounter these,
please report these to the LPRng mailing list.
<tscreen>
<verb>
configure
make all
# installs ifhp and textps in /usr/local/lib/filters
# installs ifhp.conf in /etc
#  (if already present, in /etc/ifhp.conf.sample)
make install
</verb>
</tscreen>
<sect1> Printcap Configuration
<p>
The basic LPRng printcap configuration is:
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)  <newline>
lp:lp=lp@serverhost  <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp<newline>
&nbsp;&nbsp# version 1 - using -T options  <newline>
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp -T<bf/options/  <newline>
&nbsp;&nbsp:of=/.../ifhp -T<bf/options/  <newline>
&nbsp;&nbsp<newline>
&nbsp;&nbsp# version 2 - using ifhp printcap entry  <newline>
&nbsp;&nbsp:ifhp=<bf/options/  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<p>
As shown,
options can be passed on the command line using the
<tt/-Toption,option/
method or put into the
<tt/:ifhp=option,option/
list.
<p>
Since commas are used to separate options in the
<tt/-T/
option list,
if you want to specify an option with a list of values
the values need to separated with a semicolon
(<tt/;/)
as shown below:
<tscreen>
  ifhp -Tconfig=./ifhp.conf;/etc/ifhp.conf;./ifhp.conf
</tscreen>
<p>
By convention,
the
<tt/ifhp/
filter takes its input from STDIN (file descriptor 0)
and expects to write its output to STDOUT (file descriptor 1),
which is normally connected to a printer.
Error and trace information are written to STDERR (file descriptor 2).
<p>
As shipped,
the
<tt/ifhp.conf/
file is configured to support a PJL printer which has
the following configuration.
The configuration flags that support or enable these
features are shown as well.
<enum>
<item> PJL support (<tt/pjl/).
<item> PostScript (PS) support (<tt/ps/).
<item> PCL support (<tt/pcl/).
<item> Text files printed as PCL (<tt/text/, <tt/default_language=pcl/).
<item> Banner printing done by LPRng spooler (<tt/banner@/)
<item> Status reported from printer (over bidirectional file descriptor 1)  (<tt/status/)
<item> Synchronize at start and end (<tt/sync/)
<item> Get pagecount information (<tt/pagecount/)
</enum>
<p>
The following printers have specfic configuration sections
which are invoked by using the
<tt/model=name/
option.
The HP DeskJet and DesignJet printers use the same
<tt/hpdj/ prefix with the model appended.
See Appendix A in the Printer Job Language Technical Reference Manual
for a detailed explanation of these names.
<tscreen>
<verb>
apple     hp4000      hp4          hp4l         hp4lc
hp4m      hp4ml       hp4mp        hp4mplus     hp4mv
hp4p      hp4pj       hp4plus      hp4si        hp4simx
hp4v      hp5         hp5l         hp5m         hp5mp
hp5p      hp5si       hp5simopier  hp5simx      hp6l
hp6mp     hp6p        hpcolorlj5   hpcolorlj5m  hpcolorlj
hpdj1200c hpdj1600c   hpdj2000cp   hpdj200      hpdj220
hpdj230   hpdj2500cp  hpdj250c     hpdj330      hpdj350c
hpdj350c  hpdj430     hpdj450c     hpdj455ca    hpdj600
hpdj650c  hpdj700     hpdj750c     hpdj750cplus hpdj755cm
hpiiisi   hpljpro     hppjxl300    postscript   ps
tek       qms1725
</verb>
</tscreen>
<p>
In addition to HP printers,
there is also generic support for PostScript only printers.
<sect1>PS, PCL, PJL Printer with Network Connection
<p>
This is the most common configuration,
and the printcap entry would have the following format:
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)  <newline>
lp:lp=lp@serverhost  <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp#:lp=<it/printer ip address or DNS name/%9100 <newline>
&nbsp;&nbsp# eg - :lp=nwpr%9100 <newline>
&nbsp;&nbsp# eg - :lp=10.1.1.1%9100 <newline>
&nbsp;&nbsp:lp=10.1.1.1%9100 <newline>
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp
</tscreen>
<p>
If you have an HP printer in the above list,
you can use:
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)  <newline>
lp:lp=lp@serverhost  <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp:lp=<it/printer ip address or DNS name/%9100 <newline>
&nbsp;&nbsp:ifhp=model=<it/name/
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<sect1>PS, PCL, PJL Printer with Parallel Port Connection
<p>
Since the parallel port is unidirectional,
you cannot get status back,
and need to use the
<tt/status@/ option to prevent the
<tt/ifhp/ filter from expecting it.
The printcap entry would have the following format:
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)  <newline>
lp:lp=lp@serverhost  <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp# parallel port <newline>
&nbsp;&nbsp:lp=<it>/dev/lpt</it> <newline>
&nbsp;&nbsp:ifhp=status@ <newline>
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<p>
<sect1>PS, PCL, PJL Printer with Serial Port
<p>
The LPRng print spooler will open and set the serial
line characteristics,
and pass the open connection to the
<tt/ifhp/ filter.
The 
<tt/tty/ connection must pass all 8 bits with no parity,
and should use hardware flow control if at all possible.
for your system,
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)  <newline>
lp:lp=lp@serverhost  <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp# serial port <newline>
&nbsp;&nbsp:lp=<it>/dev/ttyxxx</it> <newline>
&nbsp;&nbsp:stty=38400 -echo -crmod -raw -oddp -evenp \ <newline>
&nbsp;&nbsp   ixon pass8 -ixany cbreak crtscts <newline>
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<sect1>PostScript Only Printer
<p>
Use the configuration appropriate to the printer connection,
and then use the
<tt/pjl@/, <tt/pcl@/, and <tt/text@/
option to inhibit everything but PostScript.
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)<newline>
lp:lp=lp@serverhost <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/ <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp:ifhp=pcl@,pjl@,text@ <newline>
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<p>
If you have a parallel port printer with no PostScript support,
you would use:
<tscreen>
:ifhp=pcl@,pjl@,text@
</tscreen>
<p>
An alternative is to use the
<tt/model=ps/
configuration section of the default
<tt>/etc/ifhp.conf</tt> file.
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)  <newline>
lp:lp=lp@serverhost  <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp:ifhp=model=ps
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<p>
If your printer does not like to have a PostScript EOJ (Control-D)
flag at the start of a job,
use the
<tt/no_ps_eoj/
(<ref id="no_ps_eoj" name="No PS EOJ at Start">) flags.
flag to remove them.
<sect1>PostScript Only Printer With Text Conversion
<p>
You can use the PostScript Only configuration above,
and add text to postscript conversion to it.
This is done by defining the pathname to a text to PostScript
conversion program and causing ifhp to use the
program to convert the input file to PostScript.
The
<it/a2ps/
program can be obtained from
<htmlurl url="http://www-inf.enst.fr/~demaille/a2ps/"
name="http://www-inf.enst.fr/~demaille/a2ps/" >
and does an excellent job.
Also,
the
<tt/textps/
program included with this distribution does a (barely) adequate job as well.
<p>
The method outlined here assumes that the input file
is a text file and that the <tt/a2ps/ program will convert it.
The
<tt/a2ps/ program needs to be explicitly told that output
is to go to
<tt/STDOUT/ or file descriptor 1.
<tscreen>
<verb>
text_converter=/usr/local/bin/a2ps -o-
text_converter_output=ps
tempfile=/var/tmp/ifhp
</verb>
</tscreen>
<tscreen>
# printer setup  <newline>
#  force clients (lpr, lpq, to use server)  <newline>
lp:lp=lp@serverhost  <newline>
# server information  <newline>
lp:server  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp:ifhp=pcl@,pjl@,text@,text_converter=...,\ <newline>
&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text_converter_output=ps&nbsp;<newline>
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<p>
<sect1>Tektronixs Phaser Series Printer with Network Connections
<p>
The Tektronics Phaser Series printers use the
<it/Appsocket/ protocol when sending a job to the printer.
This protocol is (briefly):
<enum>
<item> The printer listens for UDP packets on port 9101
and for TCP/IP connections on port 9100.
<item> When a UDP packet is recieved on port 9101, then a reply
packet containing the status is returned to the originator's
address.
This packet contains an status indication,
in a <em/undefined/ format.
<item> To send a job to the printer,  a TCP/IP connection is opened to port
9100,
and a PostScript job is sent.
Only a single job can be sent at a time - a EOJ (CTRL-D)
will terminate input and flush all following jobs.
<item>
Return status will be sent in the reverse direction until the job
has completed,
at which point the connection will be closed.
</enum>
<p>
The <tt/ifhp/ program supports the <tt/appsocket/ protocol.
In order to do so,
the following ifhp configuration entry can be used.
<tscreen>
<verb>
[ tek ]
appsocket
pjl@
pcl@
</verb>
</tscreen>
The <tt/appsocket/ option will use the appsocket protcol,
and cause <tt/ifhp/ to open and close connections to the printer.
The printcap entry should specify
<tt>lp=/dev/null</tt>
and provide the device IP address using the <tt/-Tdev=host%port/ option.
<tscreen>
# Phaser Setup
lp:server  <newline>
&nbsp;&nbsp:<it>lp=/dev/null</it>  <newline>
&nbsp;&nbsp:sd=<it/spooldir/  <newline>
&nbsp;&nbsp:...  <newline>
&nbsp;&nbsp:ifhp=model=tek,dev=10.0.0.1%9100<newline>
&nbsp;&nbsp#path to ifhp filter  <newline>
&nbsp;&nbsp:if=/.../ifhp  <newline>
&nbsp;&nbsp:of=/.../ifhp  
</tscreen>
<p>
<sect> Configuration Tutorial
<p>
This section is a basic tutorial on using many of the features of
the
<tt/ifhp/
filter.
If you plan to make use of any of the advanced filter options or
modify the configuration,
you should read and try out several of the
configuration exercises.
<sect1> Configuration Files and Testsupport Directory 
<p>
These exercises require the use of several configuration files
that have predefined values as well as the
default
<tt>/etc/ifhp.conf</tt> file.
The test files are normally located in the distribution 
<tt>testscripts</tt>
directory.
It is assumed that these exercises will be done in that
directory.
<p>
The
<tt/config=path;path;path/
option specifies the list of configuration files for
<tt/ifhp/
to read.
Here is a sample of the configuration file
<tt/t1.conf/:
<tscreen>
<verb>
# modify the next line to contain
#  the name, IP address, or pathname of the printer
dev=CHANGE_THIS
debug=3
stty=38400 -echo -crmod -raw -oddp -evenp ixon pass8 -ixany cbreak crtscts
trace
ps@ 
pjl@
pcl@
text
</verb>
</tscreen>
<p>
The command
<tscreen>
ifhp -T/etc/ifhp.conf;t1.conf
</tscreen>
will cause the
<tt>/etc/ifhp.conf</tt> and then the
<tt/t1.conf/ file to be read and configuration information extracted.
<p>
The various options in this file are quite important for debugging
and testing.
The
<tt/debug/
and
<tt/trace/
options can also be specifed on the command line,
and cause the debug facilities to be turned on and debug trace output
to be put to
<tt/STDERR/.
Normally,
trace output is written only to the
<tt/statusfile/
specified by the command line
<tt/-s/ option or the configuration file
<tt/statusfile=path/ entry.
<p>
The
<tt/text/ entry causes the filter to accept text files
and simply pass them through without processing,
and the
<tt/ps@/
<tt/pjl@/
<tt/pcl@/
entries disable related processing.
<sect1> Output Device Specification
<p>
In normal operation,
<tt/ifhp/
sends its output to
<tt/STDOUT/ or file desciptor 2.
However,
when testing or using the
<tt/ifhp/
filter in standalone mode,
it is useful to have the filter open the connection
to a file or device directly.
The following sections
discuss how to modify the configuration file to do this,
as well as how to implement a simple
a
<sect1> Output to a File
<p>
This method is useful when trying to debug a set of configuration
options and you want to capture output to a file.
The
<tt>dev=path</tt>
option is used to specify the output pathname.
<enum>
In the
<tt/testscripts/
directory,
copy the
<tt>t1.conf</tt>
file to
<tt>ifhp.conf</tt>
and edit 
<tt>ifhp.conf</tt>
so it has the following lines:
<tscreen>
<verb>
# dev=/tmp/out
# debug=3
stty=38400 -echo -crmod -raw -oddp -evenp ixon pass8 -ixany cbreak crtscts
trace
ps@ 
pjl@
pcl@
text
</verb>
</tscreen>
<item>
Run the indicated commands and you should see similar output:
<tscreen>
<verb>
##> ifhp -Tconfig=./ifhp.conf < hi.txt
ifhp 12:28:20.603 [6089] Process_job: setting up printer
ifhp 12:28:20.605 [6089] Do_accounting: accounting at start, pagecount 0, pages 0
ifhp 12:28:20.605 [6089] Process_job: sending job file
ifhp 12:28:20.605 [6089] Send_job: starting transfer
Hello World

ifhp 12:28:20.606 [6089] Send_job: finished writing file, cleaning up
ifhp 12:28:20.606 [6089] Process_job: sent job file
ifhp 12:28:20.606 [6089] Process_job: doing cleanup
ifhp 12:28:20.606 [6089] Do_accounting: accounting at end, pagecount 0, pages 0
ifhp 12:28:20.606 [6089] Process_job: done
</verb>
</tscreen>
<item>
Now modify the
<tt/ifhp.conf/ file to look like:
<tscreen>
<verb>
dev=/tmp/out
debug=3
trace
ps@ 
pjl@
pcl@
text
</verb>
</tscreen>
<item>
Run indicated commands and you should see similar output:
<tscreen>
<verb>
##&gt; ifhp -Tconfig=./ifhp.conf < hi.txt
ifhp 12:33:39.504 [6155] Open_device: device '/tmp/out'
ifhp 12:33:39.505 [6155] Open_device: device '/tmp/out', attempt 1
ifhp 12:33:39.506 [6155] Open_device: success
ifhp 12:33:39.506 [6155] main: fd 1 device 0100000
&nbsp;...
</verb>
</tscreen>
<item>
Clearly this is very verbose diagnostic or trace output.  However,
if you use
<tt>cat /tmp/out</tt>
you will see the output has been written correctly.
Try using the following command to redirect trace and error output
to a file for later examination.
<tscreen>
<verb>
CSH                     SH
ifhp ... &lt;in &gt;&amp;out      ifhp ... &lt;in 2&gt;out
</verb>
</tscreen>
</enum>
<sect1> Default ifhp.conf File and Simple CRLF Filter
<p>
In order to simplify operation,
if there is a
<tt/ifhp.conf/ file in the current directory,
then the
<tt/ifhp/ program will read this file first,
followed by
<tt>/etc/ifhp.conf</tt>
and then rereads the
<tt>ifhp.conf</tt>
This has the effect of extracting critical option information on the
first pass through
<tt>ifhp.conf</tt>,
then reading the default information from
<tt>/etc/ifhp.conf</tt>,
and finally re-reading
<tt>ifhp.conf</tt> to override any defaults. 
<enum>
<item>
Try the simple commands
<tscreen>
<verb>
echo >/tmp/out
ifhp <hi.txt
</verb>
</tscreen>
and note that it produces the same output as befoe.
<item>
Now modify the
<tt>ifhp.conf</tt> file to contain:
<tscreen>
<verb>
dev=/tmp/out
debug=3
trace
ps@ 
pjl@
pcl@
text
crlf
</verb>
</tscreen>
and do
<tscreen>
ifhp &lt;hi.txt
</tscreen>
again, without clearing the output file.
<item>
If you examine 
<tt>/tmp/out</tt>output using the 
<tt/od/ or <tt/hexdump/ file dump programs or the
<tt/vi/ text editor,
you will find that the LF
(<tt/\n/) character has been replaced by
CR LF (<tt/\r\n/).
<item>
You can use the
<tt/ifhp/
program as a simple CRLF filter by specifying:
<tscreen>
ifhp -Tcrlf,language=unknown &lt;hi.txt
</tscreen>
<p>
The
<tt/language=unknown/ option specifies that the ifhp
program is not to guess at the language type,
and then does CRLF translation.
</enum>
<sect1> HP Jetdirect or Compatible Network Interface
<p>
If a printer has HP Jetdirect compatibility,
then the printers TCP/IP port 9100 will accept jobs
for printing and provide printer status.
<p>
Other manufacturers make similar products,
and may support equivalent functionality on different ports.
If you are using a Network Printer Box with multiple printer ports,
then each printer port is accessible using a specific TCP/IP port.
For example,
parallel ports P1, P2, and P3 and on a JetDirect box are usually accessed
using TCP/IP ports 9100, 9101, and 9102 respectively.
<p>
If you are using a Network Printer Box and are connecting to a
parallel port printer,
then you may not get status or error messages back from the printer
unless both the printer and the Network Printer Box use bi-directional
communication.
<p>
In the following discussions,
we will assume that you have assigned an IP address to the printer,
and that it is <tt/nwpr/,
and that status and error information is returned over the network
connection.
<enum>
<item>
First,
verify that your printer is accessible on the network by using
<tt/ping/.
It is amazing how many problems are caused by erroneous
network addresses.
<tscreen>
astart: {298} % ping nwpr <newline>
PING nwpr.astart.com (10.0.0.10): 56 data bytes <newline>
64 bytes from 10.0.0.10: icmp_seq=0 ttl=60 time=4.286 ms 
</tscreen>
<item>
Now use
<tt/telnet/
to check that you can connect to port 9100.
<tscreen>
<verb>
astart: {299} % telnet nwpr 9100
Trying 206.71.174.206...
Connected to nwpr.astart.com.
Escape character is '^]'.
...
</verb>
</tscreen>
<item>
If you have a PostScript printer,
then you might want to play with the PostScript Interactive mode,
described in
Appendix D.5 of the PostScript Language Reference Manual
by Adobe Systems.
Simply type the command
<tscreen>
executive
</tscreen>
as the first characters that are sent.
You should see:
<tscreen>
<verb>
>># telnet nwpr
Connected to nwpr.astart.com.
Escape character is '^]'.
executive
PostScript(r) Version 2013.111
(c) Copyright 1984-1993 Adobe Systems Incorporated.
Typefaces (c) Copyright 1981 Linotype-Hell AG and/or its subsidiaries.
All Rights Reserved.
PS>
</verb>
</tscreen>
<item>
You may want to try sending a simple file to the printer
and examining what happens.
This is easily done using the
<tt/netcat/
program  by Mudge.
See
<htmlurl url="http://www.l0pht.com/~weld/netcat/index.html"
name="http://www.l0pht.com/~weld/netcat/index.html" >
for general information.
<item>
The
<tt/hi.txt/
file contains
<tscreen>
Hello World <newline>
^L 
</tscreen>
where <tt/^L/ is the form feed character
You can send this file to the printer using:
<tscreen>
nc printer 9100 &lt;hi.txt
</tscreen>
<p>
The printer should start up and print a single page of output.
You may need to use
<tt/CTRL-C/ to 
terminate the
<tt/nc/
program.
<item>
If you have a PostScript printer,
you might try sending a simple PostScript test program to the printer
as well.
The
<tt>ellipse.ps</tt>
file can be sent using:
<tscreen>
nc printer 9100 &lt;/tmp/hi1.txt
</tscreen>
<item>
You can now test the basic
<tt/ifhp/
functionality.
<item>
Copy the
<tt>t1.conf</tt>
file to
<tt>ifhp.conf</tt>
and edit is so it has the correct network printer information.
<tscreen>
# modify the next line to contain <newline>
#  the name, IP address, or pathname of the printer
dev=<it/nwpr/%9100 <newline>
debug=3 <newline>
trace_to_stderr <newline>
ps@
pjl@
pcl@
text 
</tscreen>
<item>
Now do the indicated command; you should get similar output
<tscreen>
<verb>
astart: {542} % ifhp &lt;hi.txt
</verb>
</tscreen>
Note the extreme verbosity of output.
<item>
At this point you might want to try getting page numbers and doing
synchronization.
If you have a HP printer that supports PJL,
then modify
<tt>t2hp.conf</tt> as above.
This file has the contents:
<tscreen>
<verb>
# modify the next line to contain <newline>
#  the name, IP address, or pathname of the printer
dev=<it/nwpr/%9100 <newline>
#debug=3 <newline>
trace_to_stderr <newline>
text <newline>
pjl <newline>
sync=pjl <newline>
pagecount=pjl <newline>
</verb>
</tscreen>
Now use the following command and you should see similar output.
<tscreen>
<verb>
ifhp '-Tconfig=t2hp.conf;/etc/ifhp.conf;t2hp.conf' &lt; hi1.txt
ifhp 16:44:16.541 [3199] Process_job: setting up printer
ifhp 16:44:16.545 [3199] Do_sync: starting sync using 'pjl'
ifhp 16:44:17.935 [3199] Check_device_status: device = 'Toner Low'
ifhp 16:44:18.116 [3199] Do_sync: sync done
ifhp 16:44:18.117 [3199] Do_pagecount: getting pagecount using 'pjl'
ifhp 16:44:20.011 [3199] Do_pagecount: final pagecount 63304
ifhp 16:44:20.013 [3199] Do_accounting: accounting at start, pagecount 63304, pages 0
ifhp 16:44:20.013 [3199] Process_job: sending job file
ifhp 16:44:20.014 [3199] Send_job: starting transfer
ifhp 16:44:20.115 [3199] Use_file_util: file identified as 'ascii text ', assigned type 'text'
ifhp 16:44:20.119 [3199] Send_job: finished writing file, cleaning up
ifhp 16:44:20.119 [3199] Process_job: sent job file
ifhp 16:44:20.119 [3199] Process_job: doing cleanup
ifhp 16:44:20.120 [3199] Do_sync: starting sync using 'pjl'
ifhp 16:44:22.175 [3199] Do_sync: sync done
ifhp 16:44:22.176 [3199] Do_waitend: getting end using 'pjl'
ifhp 16:44:22.529 [3199] Check_device_status: device = 'Warming Up'
ifhp 16:45:04.669 [3199] Check_device_status: device = 'Toner Low'
ifhp 16:45:21.361 [3199] Do_pagecount: getting pagecount using 'pjl'
ifhp 16:45:23.241 [3199] Do_pagecount: final pagecount 63305
ifhp 16:45:23.243 [3199] Do_accounting: accounting at end, pagecount 63305, pages 1
ifhp 16:45:23.243 [3199] Process_job: done
</verb>
</tscreen>
<item>
At this point,
you should be able to send jobs to the printer,
and now need to put these options into the printcap file.
Please see the section on
<ref id="finetune" name="Printcaps and Fine Tuning Configurations">
</enum>
<sect1> Serial Port
<p>
If your printer is attached using a serial port,
then you must make sure that the communication channel is
configured correctly.
The
<tt>dev=/dev/ttyxxx</tt>
and
<tt>stty=...</tt>
configuration options will open the serial port
and configure the line in an appropriate manner.
For details on the exact form of the
<tt/stty/ options,
please consult the
LPRng-HOWTO documentation.
<enum>
<item>
Copy the
<tt>t1.conf</tt>
file to
<tt>ifhp.conf</tt> and edit it
so it has the following lines:
<tscreen>
# modify the next line to contain <newline>
#  the name, IP address, or pathname of the printer
dev=<it>/dev/serialport </it><newline>
#debug=3 <newline>
stty=38400 -echo -crmod -raw -oddp -evenp ixon
  pass8 -ixany cbreak crtscts
trace_to_stderr <newline>
text 
</tscreen>
<p>
Now run the
<tt/ifhp/
program as shown below.
You should see output similar to:
<tscreen>
<verb>
astart: {542} % ifhp &lt;h11.txt
ifhp 15:57:23.734 [3096] Process_job: setting up printer
ifhp 15:57:23.736 [3096] Do_accounting: accounting at start, pagecount 0, pages 0
ifhp 15:57:23.736 [3096] Process_job: sending job file
ifhp 15:57:23.736 [3096] Send_job: starting transfer
ifhp 15:57:23.737 [3096] Send_job: finished writing file, cleaning up
ifhp 15:57:23.737 [3096] Process_job: sent job file
ifhp 15:57:23.738 [3096] Process_job: doing cleanup
ifhp 15:57:23.738 [3096] Do_accounting: accounting at end, pagecount 0, pages 0
ifhp 15:57:23.738 [3096] Process_job: done
</verb>
</tscreen>
and you should get a printed page.
<item>
If you do not get communication,
then you will have to start a long and painful process of debugging.
First,
check that the various modem control signals
are correct.
You should invest a small amount of time and energy and purchase
a
<bf/breakout box/ that shows the status of the various control signals.
If only the
<bf/XMIT Data/ signal is active,
you will need to put a crossover (null modem)
between the printer and your serial port.
<p>
Check the
<bf/DTR/ (Data Terminal Ready),
<bf/DCD/ (Data Carrier Detect),
<bf/RTS/ (Request To Send),
and
<bf/CTS/ (Clear To Send).
These should all be ON or active.
Some systems will use
<bf/RTS/ (Request To Send)
and
<bf/CTS/ (Clear To Send) for
<it/hardware flow control/
and it is possible that these signals will become stuck.
It is strongly recommended that flow control on the host be turned off,
and let the printer do flow control using 
<bf/RTS/ and
<bf/CTS/.
<item>
Once you get the basic configuration working,
then you should follow the basic steps in the
previous section on Network Interfaces,
and try sending files of different types.
</enum>
<sect1> Parallel Port
<p>
The parallel port configuration is the easiest to implement,
but the most limited in abilities.
<enum>
<item>
Copy the
<tt>t1.conf</tt>
file to
<tt>ifhp.conf</tt> and edit it
so it has the following lines, with the
<tt/dev/ value replaced by the correct pathname.
<tscreen>
# modify the next line to contain <newline>
#  the name, IP address, or pathname of the printer <newline>
dev=<it>/dev/lp</it> <newline>
debug=3 <newline>
stty=38400 -echo -crmod -raw -oddp -evenp ixon pass8 -ixany cbreak crtscts <newline>
trace <newline>
ps@ <newline>
pjl@ <newline>
pcl@ <newline>
text <newline>
</tscreen>
<item>
Now run the
<tt/ifhp/
program:
<tscreen>
ifhp &lt;hi.txt
</tscreen>
<item>
You should see output similar to:
<tscreen>
<verb>
astart: {542} % ifhp -Tconfig=.../testscripts/t1.conf &lt;h11.txt
ifhp 15:57:23.734 [3096] Process_job: setting up printer
ifhp 15:57:23.736 [3096] Do_accounting: accounting at start, pagecount 0, pages 0
ifhp 15:57:23.736 [3096] Process_job: sending job file
ifhp 15:57:23.736 [3096] Send_job: starting transfer
ifhp 15:57:23.737 [3096] Send_job: finished writing file, cleaning up
ifhp 15:57:23.737 [3096] Process_job: sent job file
ifhp 15:57:23.738 [3096] Process_job: doing cleanup
ifhp 15:57:23.738 [3096] Do_accounting: accounting at end, pagecount 0, pages 0
ifhp 15:57:23.738 [3096] Process_job: done
</verb>
</tscreen>
and you should get a printed page.
</enum>
<sect1> Fine Tuning A Configuration and Printcap Entries
<label id="finetune"
<p>
If you have followed the above directions,
you should now be able to use the IFHP filter with
very little additional configuration.
You can now set up your printcap to use the
<tt/ifhp/ filter.
The following discussion assumes that you are using LPRng.
<sect1> ifhp.conf Defaults
<p>
While the above set of exercises are useful for debugging
and testing,
you should always let the LPRng spooler open the printing device
or make the network connection.
<p>
Examine the
<tt>/etc/ifhp.conf</tt>
file.
The default configuration is for a HP family printer
which supports pagecounting using PJL,
synchronization using PJL,
and other standard items.
<p>
If the default configuration does not meet your needs,
and you do not want to use the printcap
<tt/:ifhp/
entry
or pass options using the
<tt/-T/
command line entries,
you can create your own entry in a
<tt>/... spooldir .../ifhp.conf</tt>
file.
This entry should have the form:
<tscreen>
<verb>
option
&nbsp;...
</verb>
</tscreen>
<p>
For example,
we might want to configure a printer that supports PCL and PostScript,
needs to convert Text to PostScript,
and does not have status capability.
This is similar to an HP3 with a PostScript cartridge on a parallel port.
<tscreen>
<verb>
status@
pjl@
pcl
ps
text@
text_converter=/usr/local/bin/a2ps -o-
text_converter_output=ps
</verb>
</tscreen>
<p>
An alternative to this method is to create a new entry in the
<tt>/etc/ifhp.conf</tt>
file and reference this.
This method has the benefit of centralizing management of the
printing configuration.
You usually put such an entry at the end of the
<tt>/etc/ifhp.conf</tt>
file,
and it would have the form:
<tscreen>
<verb>
[ hp3_parallel ]
status@
pjl@
pcl
ps
text@
text_converter=/usr/local/bin/a2ps -o-
text_converter_output=ps
</verb>
</tscreen>
<p>
You would modify the printcap so that the model was passed
either in the
<tt/:ifhp/ information or as a command line option:
<tscreen>
<verb>
printer:...<newline>
  :if=/.../ifhp -Tmodel=hp3_parallel<newline>
  :of=/.../ifhp -Tmodel=hp3_parallel<newline>
  # or you can use this
  :ifhp=model=hp3_parallel
</verb>
</tscreen>
<sect1> Extending ifhp Capabilties
<label id="ps_user_opts">
<label id="pcl_user_opts">
<p>
One problem faced by system administrators
is the need to allow users to configure various options in a job
specific manner.
In order to support this,
the LPRng print spooler passes the
<tt/lpr -Z/
command line options through to the print spooler,
where they are used by the
<tt/ifhp/
filter.
<p>
The details of how these options are used are explained in detail
in the following sections,
but here is an overview of how commands can be added.
<p>
The
<tt/pjl_user_opts=[ ... ]/,
<tt/pcl_user_opts=[ ... ]/,
and
<tt/ps_user_opts=[ ... ]/
are options with predefined meanings.
The values of these options specify
<tt/-Z/
and
<tt/-T/
command line options that will be processed by the
<tt/ifhp/
filter when
<tt/pjl/, <tt/pcl/, or <tt/ps/ configuration needs to be done.
Here is a sample configuration file section,
and an example.
<tscreen>
<verb>
# we add the upper and lower keywords
#  lpr -Zupper  or lpr -Zlower will be specified by the user
pjl_user_opts=[ upper lower ]
pjl_upper=@PJL SET INTRAY=TRAY1
pjl_lower=@PJL SET INTRAY=TRAY2

#  lpr -Zpagesetup
pcl_user_opts=[ pagesetup ]
pcl_pagesetup=[ lines=12 cols=4 ]
lines=20
pcl_lines=\033*(\%{lines}L
cols=2
pcl_cols=\033*(\%{cols}C
</verb>
</tscreen>
<p>
If the user specifies
<tt/lpr -Zupper/,
if
<tt/PJL/
is available on the printer
(<tt/pjl/ is set),
then the
<tt/-Z/
option list is scanned for an option that is also in the
<tt/pjl_user_opts/.
The
<tt/upper/
option is found,
and then the value for
<tt/pjl_upper/
is located and sent to the printer.
By prefixing the context or language that is needed,
we can have multiple language dependent actions for the same option.
<p>
The
<tt/lpr -Zpagesetup/
option is more complex,
mainly due to the range of possibilities the PCL offers.
The
<tt/pagesetup/
option is found in the
<tt/pcl_user_opts/ list,
but when
<tt/pcl_pagesetup/
is found,
it turns out to be a list of values.
<p>
The list values are expanded in turn,
resulting in
<tt/pcl_lines/
and
<tt/pcl_cols/
being expanded in turn.
The <tt/pcl_lines=\033*(\%{lines}L/
uses the common C/C++/Perl escape sequences,
with the following addition:
<tt/\%{name}/
is replaced by the value for the option name found by searching
in order a
a stack of values that have been set by the recursive expansion,
the
<tt/-Z/ options,
<tt/-T/ options, 
and the configuration file.
In this example,
we would produce the output string
<tscreen>
<verb>
\033*(12L\033*(4C
</verb>
</tscreen>
<p>
For examples of how to add these commands,
please examine the default
<tt>/etc/ifhp.conf</tt>.
<sect1>PCL and PostScript End of Job Sequences
<label id="no_ps_eoj">
<label id="no_pcl_eoj">
<p>
One of the more troublesome problems with printing PCL and PostScript
jobs is to initialize the printer when a previous job has failed.
This is commonly done by prefixing a job file with a
<em/end of job/
sequence for the particular language.
For PostScript,
this the the Control-D (<tt/\004/) character,
and for PCL the ESCAPE E (<tt/\033E/) sequence.
<p>
One problem with using this approach is that when you want to prefix a job
with additional PCL or PostScript,
you need to remove the existing end of job sequences,
or the prefixed commands will have no effect.
By default,
the <tt/ifhp/
filter will do this.
In addition,
it will also
prefix the new commands with
an appropriate end of job sequence.
<p>
However,
there are certain models of printers which do not like to have
end of job sequences at the start of jobs.
To suppress the prefixing of PostScript jobs with the PostScript end of job,
set the
<tt/no_ps_eoj/
flag,
and 
to suppress the prefixing of PCL jobs with the PCL end of job,
set the
<tt/no_pcl_eoj/
flag.
<sect>Filter Operation Details
<p>
The
<tt/ifhp/
filter operates by first reading a configuration file
to determine the type of printer it is working with,
and then proceeds to carry out operations requested by the values of
option variables passed on the command line or found in the configuration
files.
In normal operation,
input is read from 
<tt/STDIN/
(file descriptor 0),
massaged in the appropriate manner,
and then written out to
<tt/STDOUT/ (file descriptor 1).
Status reports are written to
a status file, or optionally to
<tt/STDERR/ (file descriptor 2),
together with any error messages or diagnostics.
<p>
In addition to normal operation
the filter can run in the
<bf/OF/ mode and act as a printer initializer and job terminator.
This is discussed in detail in the LPRng documentation.
When in the OF mode,
The first nonblank input line will be treated as
a request to generate a banner.
The string "\031\001" will cause the filter to suspend operations
using a SIGSUSP signal.
At this point,
job files will be sent to the output device by the spooler,
and the filter will then be restarted with a SIGCONT signal.
<p>
These steps are best explained algorithmically.
The following is a <em/pseudo-code/ description of the steps
performed during the printing activity.
The sections marked with <tt/###/ are discussed later in this document
in detail.
<p>
<tt>///</tt> See: <ref id="setup" name="Options, Initialization and Setup" >
<tscreen>
<verb>
###+++ Initialization and Setup
// get ifhp information from PRINTCAP_ENTRY environment variable
if( PRINTCAP_ENTRY environment variable has a value ){
	split printcap information into printcap fields
	if( :ifhp=options,options is present in printcap ){
		split the options list and place in the Toptions list
	}
}
foreach option in -Toptions, -Zoptions do
    if( option = "debug=level"  and Debuglevel not set ){
        set Debuglevel = level;
    }
    if( option = "trace" ){
        output error and trace on STDERR
    }
    if( option = "config=pathlist" and from -Toption ){
        set configuration pathlist = pathlist;
    }
    if( option = "model=name" and model not set ){
        set model = name;
    }
}
</verb>
</tscreen>
<tt>///</tt> See: <ref id="optioninit" name="Operation Configuration Options">
<tscreen>
<verb>
// extract configuration information
foreach path in configuration pathlist {
    open path;
    for each line in file information {
		if( line is selected to be in configuration ){
			process input line, adding it to configuration
			if( line is 'debug=','model='
			   and the corresponding value not set ){
			   set the value;
			}
		}
    }
}

// get values of options with predefined meanings
// these include status, forcestatus, etc
foreach option in predefined list {
	if( option=value is in selected configuration information ){
		set option=value;
	}
}

// open a direct connection if specified
if( device specified using -Tdev=device ){
	// if device is host%port, we open TCP/IP connection
	fd = open(device);
	dup fd to 1; close fd;
}
if( appsocket procotol specified and TCP/IP device ){
	udp_socket = open( udp socket to device%port+1 )
}


###---
</verb>
</tscreen>
<tt>///</tt> See: <ref id="syncpage" name="Synchronization and Pagecount" >
<tscreen>
<verb>
###+++ Synchronization and Pagecount
if( status returned by printer and sync requested ){
    // APPSOCKET protocol
    // sync has the form sync@ (none), sync=ps, sync=pjl, ...
	if( appsocket ){
		command = "\n\r"
	} else {
		// decode status=language and determine sync
        if( sync = pjl and PJL ECHO available ){
            send PJL ECHO command to printer
		} else if( sync = ps ){
            send PS program to printer
		} else {
			terminate with error;
		}
	do{
		send command and wait for timeout;
    } while( no response );

	if( appsocket ){
		close and reopen TCP/IP connection;
	}

    // pagecount has the form pagecount@ (none),
    //   pagecount=ps, pagecount=pjl, ...
    if( pagecount=language has value ) do {
		if( pagecount TRUE ){
			set pagecount= pjl or ps depending on availability
		}
        if( pagecount = pjl and PJL INFO available ){
           send PJL INFO PAGECOUNT command to printer
		} else if( pagecount = ps ){
           send PS program to printer
		} else {
			terminate with error;
		}
    } while( no pagecount response );

	if( appsocket ){
		close and reopen TCP/IP connection;
	}
}
###---
</verb>
</tscreen>
<tt>///</tt> See: <ref id="pjlinit" name="PJL Initialization" >
<tscreen>
<verb>
### PJL Initialization
if( PJL enabled ){
    language = "pjl_"
    foreach option in pjl_init=&lsqb;...&rsqb; {
       expand the option using the language value
       #+++ PJL OPTION ACTIONS +++
       if( option in pjl_vars_set=[ ... ]
         and option not in pjl_vars_except
         expand "@PJL SET OPTION=\%{option}"
         output = expanded string value
       } else {
         if( option value is a string ){
           output = expanded string value;
         }
       }
       // output has the form @PJL COMMAND ....
       if( COMMAND is in pjl_only=[ ... ]
           and not in pjl_except=[ ... ] ){
           send output to printer
       }
       #--- end PJL OPTION ACTIONS
    }
    if( !OF_mode ){
         foreach option in -Toption=value {
            if( option in pjl_user_opts ){
                #+++ USER PJL OPTIONS
                // join 'pjl_' and the option name
                expand 'pjl_' . option
                // perform PJL actions as above
                    #+++ PJL OPTION ACTIONS +++
                    ....
                    #-- PJL OPTION ACTIONS +++
                #--- USER PJL OPTIONS
            }
         }
         foreach option in -Zoption=value {
            if( option in pjl_user_opts ){
                // perform USER PJL actions as above
                #+++ USER PJL OPTIONS
                #--- USER PJL OPTIONS
            }
         }
    }
}

###--- PJL INITIALIZATION
</verb>
</tscreen>
<tt>///</tt> See: <ref id="textfile" name="Text File Conversion" >
<tscreen>
<verb>
// language is set to the type of job language
// - PS, PCL, TEXT, RAW, UNKNOWN
//  the first part of the job file is read and the filter takes
//  a (wimpy) guess at the job file based only on the first couple
//  of characters;  language is  be PJL, PS, or TEXT, or RAW
//  This is the same algorithm as the UNIX FILE utility

language = UNKNOWN
if( command line -c (binary) option present ){
    language = RAW;
} else if( -Zlanguage=xxx option present ){
    language=xxx
} else if( file is PS file ){
    language=PS
	if( file starts with PS EOJ (CTRL-D)
		and no_ps_eoj is set ){
		remove the PS EOJ
	} else {
		send a PS EOJ first
	}
} else if( file is PCL file ){
    language=PCL
	if( file starts with PCL EOJ (ESC E)
		and no_pcl_eoj is set ){
		remove the PCL EOJ
	}
} else if( file_util_path=/pathname ){
    use UNIX file utility to get file type
}

if( language = UNKNOWN and
    default_language option has value ){
    language = value of default_language;
}

if( language = TEXT ){
    if( text_converter=/path option has value ){
        run text converter on input
    } else if( printer does not support TEXT output ){
        exit with error;
    }
    language = value of text_converter_output option
}

if( language = UNKNOWN ){
    exit with error;
}
if( PJL ENTER supported ){
	use PJL ENTER command to select language;
	send nullpad NULLS to force full buffer condition
}
</verb>
</tscreen>
<tt>///</tt> See: <ref id="languageinit" name="Language Specific Initialization">
<tscreen>
<verb>
// LANGUAGE SPECIFIC INITIALIZATIONS
if( language = PCL ){
    foreach option in pcl_init {
        ###+++ expansion 
        do expansion similar to PJL OPTION actions
            using "pcl_" prefix for option lookup;
        ###---
    }
    if( not in OF_MODE ){
        foreach option in -Toption do {
            if( option in pcl_user_vars=[ ... ] ){
            ###+++ expansion as above
            ###---
        }
        foreach option in -Zoption do {
            if( option in pcl_user_vars=[ ... ] ){
            ###+++ expansion as above
            ###---
        }
    }
    remove whitespace and expand string results;
} else if( language = PS ){
    ###+++ language specific actions as above,
      using the ps_ prefix for lookup 
    expand string results but do not remove whitespace
}
</verb>
</tscreen>
<tt>///</tt> See: <ref id="filetransfer" name="File Transfer and Error Status Monitoring">
<tscreen>
<verb>
Transfer job to printer, reading error and other information
  back from the printer if enabled

if( language = PCL ){
    send PCL End of Job
} else if( language = PS ){
    send PS End of Job
}


// job terminaton

###+++ Synchronization and Pagecount as above
if( waitend ){
	if( sync requested previously ){
		if( sync with PJL ){
			wait for end of job using UINFO;
		} else if( sync with PS ){
			request status using ^T and wait for
			printing to stop
		}
	}
	if( appsocket ){
		close and reopen connection;
	}
	get pagecount using previously descibed algorithm
}
	
###---

exit
</verb>
</tscreen>
<sect1>Options, Initialization and Setup
<label id="setup">
<p>
The
<tt/ifhp/
filter is designed to work with the LPRng print spooler,
but will also work with other spooling systems.
The LPRng system will set the 
<tt/PRINTCAP_ENTRY/
environment variable to the current printcap value.
By convention,
the filter command line
<tt/-Toptions/
are reserved for the print spooler to pass configurtion inforamtion
and the
<tt/-Zoptions/
are passed by the user.
For example,
examine the following
<tt/lpr/
command and printcap example:
<tscreen>
<verb>
Printcap:
pr:...
  :ifhp=opt1=value1,opt2=value2
  :if=/usr/ifhp -Topt1=value4,opt3=value3

Command:
lpr -Zopt4=value4

PRINTCAP_ENTRY envionment variable: 
  pr:...\n
    :ifhp=opt1=value1,opt2=value2\n
    :if=/usr/ifhp -Topt1=value4,opt3=value3\n

Resulting option list:

-Toptions:
  opt1=value4
  opt2=value2
  opt3=value3

-Zoptions:
  opt4=value4

</verb>
</tscreen>
<p>
When started,
the
<tt/ifhp/
filter process the environment and command line options as follows.
<enum>
<item>
If the
<tt/PRINTCAP_ENTRY/
environment variable has a value,
then this value is used to initialize the
<tt/-Toption/
list.
<item>
If there is a
<tt/-Toption/
command line option,
then these values are added to the
option list,
overriding values from the
<tt/PRINTCAP_ENTRY/
set.
<item>
The command line
<tt/-Zoption/
list is generated by splitting the
<tt/-Zoption/
command line option.
</enum>
<p>
The option lists are scanned for values for the
<tt/debug/,
<tt/trace/,
<tt/config/,
and
<tt/model/
options.
These options
have the property that once they are set, then they cannot be modified
(i.e. - sticky values).
<p>
<label id="model_from_option">
There is another,
and rather bizarre way to specify the printer model,
and that is the
<tt/model_from_option/
option in the configuration file.
This option causes the command line options to be scanned,
and if there is a value for the command line option then it
is used as the model.
For example:
<tscreen>
<verb>
model_from_option=Q
</verb>
</tscreen>
<p>
The above setting will cause the model to be taken from the
<tt/Q/ option.
This can be used to select a configuration for the printer
based on values specifed by the user.
<sect2>Debug and Trace
<label id="debug">
<label id="trace">
<p>
The value of the
<tt/debug/
option sets the debugging level.
It can be increased, but not decreased.
The
<tt/trace/
flag causes debugging information to be sent to STDERR (file descriptor 2)
as well as to the status file.
<sect2>Configuration File Paths
<label id="configpaths">
<label id="config">
<p>
The main source of configuration information are the configuration files.
The
<tscreen>
config=pathname,pathname
</tscreen>
option can be used to specify the list of configuration files to be read.
This can only be done using the
<tt/PRINTCAP_ENTRY/
<tt/:ifhp/
entry or the
<tt/-Tconfig=pathname,pathname/
command line option.
<sect1>Model Selection
<label id="modelselect">
<label id="model">
<p>
The
<tt/model=name/
option is used to establishes the model name for extracting
configuration information.
For details on this, see
<ref id="configfiles" name="Configuration Files">.
<p>
During initialization,
the
<tt/-Toptions/
list is scanned for a
<tt/-Tmodel=name/
entry.
Once the model name is set, it cannot be changed.
After this,
the configuration files are read,
and the first
<tt/model=name/
option encountered will set the
<tt/model/
option to
<tt/name/.
<p>
The recommended method of model selection is to
specify it in the
LPRng printcap entry for the printer,
using the <tt/:ifhp=.../
printcap field.
For example:
<tscreen>
<verb>
lp:ifhp=model=HP4,status@
  :if=/usr/local/ifhp

Resulting -Toption List:
 model=HP4
 status@
</verb>
</tscreen>
<p>
This will cause the
<tt/-Toption/
list to be initialized as indicated,
and the
<tt/model/
option value will be set to
<tt/HP4/.
<p>
The next method is use a
<tt/-Toption/
command line option.
<tscreen>
<verb>
lp:...
  :if=/usr/local/ifhp -Tmodel=HP4

Resulting -Toption List:
 model=HP4
</verb>
</tscreen>
<p>
This will cause the
<tt/-Toption/
list to be initialized as indicated,
and the
<tt/model/
option value will be set to
<tt/HP4/.
<p>
Another method is to put the model information in a
<tt>./ifhp.conf</tt>
file in the spool directory of the print queue.
The
<tt>config=/pathname,/pathname,...</tt>
option specifies the list of configuration files to read,
and the default value is:
<tscreen>
<verb>
config=./ifhp.conf,/etc/ifhp.conf,./ifhp.conf
</verb>
</tscreen>
<p>
If the model information is put in the 
<tt>./ifhp.conf</tt>
configuration file,
the first reading will set the model name,
and the name is used to select the model information from the
<tt>/etc/ifhp.conf</tt>
file.
When the 
<tt>./ifhp.conf</tt>
is reread,  the values in it can be used to override values from the
<tt>/etc/ifhp.conf</tt>
file.
For example:
<tscreen>
<verb>
./ifhp.conf:
  model=HP4
  lines=66

/etc/ifhp.conf:
[ hp* ]
 lines=60
[ apple* ]
 lines=20
</verb>
</tscreen>
<p>
When the
<tt>./ifhp.conf</tt>
is first read,
it will establish
<tt/model=hp/
(sticky) and 
<tt/lines=66/.
When the
<tt>/etc/ifhp.conf</tt> file is read,
the model name matches the
<tt/hp*/ selector
(case insensive GLOB matching is used),
and the
<tt/lines=60/
is selected and overrides the
<tt/lines=66/
value.
Finally,
when the
<tt>./ifhp.conf</tt>
file is reread,
<tt/lines=66/
will establish the final value.
<sect1>Statusfile, Statusfile_max, Statusfile_min
<label id="statusfile">
<label id="statusfile_max">
<label id="statusfile_min">
<p>
The status file pathname is set by the command line
<tt>-s /pathname</tt>
or the
<tt>statusfile=/pathname</tt>
configurtion file entry.
If the
<tt>/pathname</tt>
file does not exist then it will not be created.
If the statusfile is larger than the
<tt/statusfile_max=max/
K bytes option value (default 8K),
then it will be truncated to
<tt/statusfile_min=min/
K bytes.
<sect2>Summmaryfile
<p>
<label id="summaryfile">
For historical and vintage software compatibility,
the
<tt>summaryfile=/pathname</tt>
or
<tt>summaryfile=host%port</tt>
option will cause either a file to be open or a UDP network connection
established to the host  and port combination.
Debugging or trace information will be written to this file or network
connection as well, but the file will be truncated each time,
holding only the last line of trace information.

<sect1>Operation Configuration Options
<p>
<label id="optioninit">
<label id="status">
<label id="forcestatus">
<label id="pjl">
<label id="pcl">
<label id="ps">
<label id="text">
The
<tt/-Toption=value/
and model configuration information is scanned
to set values of options which control filter activity.
There are some options whose related actions do not fall into
the simple model of string expansion.
These usually require generating commands dynamically,
or sending files containing font or setup information to the printer.
The following is a list of these options.
<sect2>status and forcestatus FLAGS
<p>
These options have the side effect of enabling the reception of status
and error information from the printer.
<sect2>pjl, pcl, ps and text FLAGS
<p>
These flags set the lanaguages that are recognized or processed by
the filter.
<sect2>crlf FLAG
<label id="crlf">
<p>
The
<tt/crlf/
causes LF (<tt/\n/) to be translated to CR-LF
(<tt/\r\n/) sequences.
The following options will turn the
<tt/ifhp/
filter into a simple CRLF translation filter.
Note that CRLF translation should have no effect
on PostScript, Text, or PCL files.
<tscreen>
<verb>
status@
pjl@
ps@
pcl@
text
text_converter_output@
text_converter@
crlf
</verb>
</tscreen>
<sect2>pjl_job FLAG
<label id="pjl_job">
<p>
If PJL is enabled and this flag is SET,
a PJL JOB and PJL EOJ command will be generated
and sent to the printer.
The JOB command has the form:
<tscreen>
&commat;PJL JOB NAME = "..." &lsqb; START = nnn &rsqb; &lsqb; END = mmm &rsqb;
</tscreen>
The START and END values can be specified by
<tt/-Zstart=nnn/
and
<tt/-Zend=mmm/
command line options.
The EOJ command has must match the JOB command.
<tscreen>
&commat;PJL EOJ NAME = "..." &lsqb; START = nnn &rsqb; &lsqb; END = nnn &rsqb;
</tscreen>
<sect2> pjl_enter FLAG
<label id="pjl_enter">
<p>
If PJL is enabled and this flag is SET,
a PJL ENTER LANGUAGE = xx command will be generated
when PCL or PS files are sent to the printer.
<tscreen>
<verb>
@PJL ENTER LANGUAGE = PCL
@PJL ENTER LANGUAGE = POSTSCRIPT
</verb>
</tscreen>
<sect2> nullpad STRING
<label id="nullpad">
<p>
Some older model HP printers required sending a large number of
NULL (0) characters to force commands in the input buffer to be read.
This can be done using the
<tt/nullpad/ option.
<p>
In practice,
this has turned out to be largely historical,
as most printers do not have this problem.
<sect2> pjl_console FLAG
<label id="pjl_console">
<p>
When this flag is set,
PJL is available,
and the PJL
<tt/RDYMSG/
command is supported,
then a short message will be put on the console.
<sect2> remove_ctrl STRING
<label id="remove_ctrl">
<p>
The
<tt/remove_ctrl/ string option species a list of (control) characters
that will be removed from PostScript jobs.
This solves the problem of jobs with embedded Control-T or Control-C
characters causing abnormal printer operation.
For example:
<tscreen>
<verb>
remove_ctrl=CT
</verb>
</tscreen>
would cause Control-C and Control-T characters to be removed.
<sect2> tbcp FLAG
<label id="tbcp">
<p>The
<tt/tbcp/
flag can be specified as a user option as well as a
configuration file option.
If the file type is PostScript and this flag is set,
then the file is transferred using the Transparent Binary Communication
Protocol.
(See the Adobe PostScript Language Reference Manual for details on
the protocol.)
<p>
At the start of the PostScript job,
the sequence <tt/\001/ <tt/M/ is sent.
Afterwards,  all control characters in the set
<tt>
0x01, 0x03, 0x04, 0x05,
0x11, 0x13, 0x14, 0x1C,
</tt>
are replaced by the two character sequence <tt/\001/
<tt/X+'@'/ or
<tt/X+'\100'/ or
is sent.
For example:
<tscreen>
<verb>
C\001\003   ->  \001\115\103\001\101\001\103 or \001MC\001A\001C
</verb>
</tscreen>
<p>
<sect1>Synchronization and Pagecounts
<label id="syncpage">
<label id="pagecount">
<label id="pagecount_interval">
<label id="pagecount_timeout">
<label id="pagecount_ps_code">
<label id="sync">
<label id="sync_interval">
<label id="sync_timeout">
<p>
Many printers are able to provide status information back to the
filter.
It is assumed that in these circumstances file descriptor 1
(FD1)
is
<em/bidirectional/
and status information can be read from it.
When the
<tt/status/
or
<tt/forcestatus/
option is TRUE,
then the filter assumes that it can read FD1.
In order to simplify configuration,
the
<tt/ifhp/
filter will test FD1, and if it is not
a serial port or a network socket, will set
<tt/status@/
or OFF.
<p>
However, there are some devices such as bidirectional printer ports
that will report status.
By setting
<tt/forcestatus/
ON,
the filter can be forced to check for status.
This can have fatal or unexpected effects if status is not returned
correctly.
<p>
Synchronization is usually done in order to ensure that a previously
spooled job or printer action has completed correctly,
and the printer is ready to accept a new job.
It is usally carried out by sending a request to the printer to
echo a string back to the filter.
Clearly,
if the printer cannot provide status or echo values back,
then synchronization is impossible.
<p>
The value of the
<tt/sync/ option determines if a PJL ECHO command or simple PostScript 
program is used.
The PostScript program has the form:
<tscreen>
\004%!PS-Adobe-2.0
<newline>
( %%[ echo: <em/TODSTR/ ]%% ) print () = flush
<newline>
\004
</tscreen>
<p>
where <em/TODSTR/ is replaced with the current Time of Day.
<p>
To control obtaining synchronization,
the
and
<tt/sync_timeout=nnn/
options are used.
The PJL or PS command is repeated at
<tt/sync_interval=nnn/
second intervals; if nnn is 0, then it is sent only once.
If synchronization is not obtained within
<tt/sync_timeout=nnn/
seconds, then the filter exits with an error status.
A 0 value or
<tt/sync_timeout@/
disables timeouts.
<p>
Pagecounts are used to do accounting and report the number of pages
used for a job.
Most printer have a hardware based pagecounter mechanism whose value
can be read by the appropriate PJL command or PostScript program.
For example, if the PJL INFO command
<tscreen>
<verb>
@PJL INFO PAGECOUNT
</verb>
</tscreen>
is supported by a printer,
the printer will return a status message containing the current pagecounter
value.
Printers that support PostScript may also be able to access the pagecounter
value using a PostScript program.
The exact details of the PostScript program vary from vendor to vendor and
the
<tt/pagecount_ps_code=.../
option specifies the PostScript program to use.
For example:
<tscreen>
<verb>
pagecount_ps_code=
  /p {print} def ( %%&lsqb; pagecount: ) p
  statusdict begin pagecount end 20 string cvs p
  ( &rsqb;%% ) p () = flush
</verb>
</tscreen>
<p>
Pagecounting is supported by the
<tt/pagecount=/<it/language/,
<tt/pagecount_interval=nnn/,
and
<tt/pagecount_timeout=nnn/
options.
The
<tt/pagecount=/<it/language/
option enables pagecounting, and sets the language to be used.
Currently
<tt/ps/ (PostScript)
and
<tt/pjl/ (PJL)
are supported.
The pagecount request is repeated every
<tt/pagecount_interval=nnn/
second intervals; if nnn is 0, then it is sent only once.
If no pagecount value is obtained within
<tt/pagecount_timeout=nnn/
seconds, then the filter exits with an error.
A 0 value or
<tt/sync_timeout@/
disables timeouts.
<p>
Some printers do not correctly report end of job and must be polled
until the pagecount information stabilizes.
The PJL TEOJ (True End Of Job) PJL has been tried with limited success
on various printers to force End of Job reporting only when the
job has finished.
<tscreen>
<verb>
pjl_init=[ ... teoj ... ]
pjl_teoj=&commat;PJL TEOJ=ON
</verb>
</tscreen>
<sect1>PJL Initialization
<label id="pjlinit">
<label id="endpage">
<label id="startpage">
<label id="pjl_only">
<label id="pjl_except">
<label id="pjl_vars_set">
<label id="pjl_vars_except">
<label id="pjl_user_opts">
<label id="pjl_init">
<p>
If a printer supports PJL,
the many printer operations can be initiated and controlled using
PJL commands.
Unfortunately,
not all printers support the same set of commands.
In addition,
not all printers support the same set of operations or options.
A PJL command has the form:
<tscreen>
@PJL COMMAND OPTION OPTION ...
</tscreen>
A PJL variable is set using:
<tscreen>
@PJL SET <it/var/ = <it/value/ ...
</tscreen>
The
<tt/pjl_only=[ ... ]/,
<tt/pjl_except=[ ... ]/,
<tt/pjl_vars_set=[ ... ]/,
and
<tt/pjl_vars_except=[ ... ]/
options are used to control which PJL commands and which PJL variables
can be set.
The 
<tt/pjl_only/
variable lists the commands supported by the printer,
and the
<tt/pjl_except/
lists commands <em/not/
supported by the printer.
Before sending a PJL command,
the
<tt/ifhp/
filter checks to make sure that the command name is in
<tt/pjl_only/
and not in
<tt/pjl_except/.
If the tests fail, then tne command is not sent.
<p>
Similarly,
when sending a command to set a PJL variable,
the
<tt/pjl_vars_set/
and
<tt/pjl_vars_except/
lists are checked to determine if the variable name is in
<tt/pjl_vars_set/
and not in
<tt/pjl_except/
list.
If the tests fail, then tne command is not sent.
<p>
If PJL is enabled,
then the following actions are taken.
<enum>
<item> PJL Universal Exit Lanaguage (UEL) <tt/\033%-12345X/ is sent to the printer.
<p>
This is required to ensure that the following PJL commands are
accepted.
<item> PJL JOB command is sent at the start of job.
The JOB command can be used to select pages or impressions to be printed.
If the
<tt/-Zstartpage=nnn/
or
<tt/-Zendpage=mmm/
option is present, then the PJL JOB command has the form:
<tscreen>
@PJL JOB START=nnn END=mmm
</tscreen>
<item> The
<tt/pjl_init=[ ... ]/
value option is expanded using the PJL
(<tt/"pjl_"/) language context as described above.
<item> The
<tt/-Toption=value/s
and
<tt/-Zoption=value/s
are scanned for matching option names in the 
<tt/pjl_user_opts=[ ... ]/ 
list.
If they are found,
then the options are recursively evaluated in the PJL language context.
The expansion alorithm will cause the option value to be used to set PJL
variables.
For example:
<tscreen>
<verb>
Configuration:
  pjl_vars_set=[ OUTBIN AUTOSELECT JAM=YES ]

Command
  ifhp -Zoutbin=upper,autoselect,jam

PJL command generated:
  @PJL SET OUTBIN=UPPER
  @PJL SET AUTOSELECT=ON
  @PJL SET JAM=YES
</verb>
</tscreen>
</enum>
<sect1>Text File Conversion
<label id="textfile">
<label id="default_language">
<label id="file_util_path">
<label id="text_converter">
<label id="text_converter_output">
<label id="text_tempfile">
<label id="language">
<p>
Many PostScript printers cannot handle text files,
and produce many hundreds of pages of garbage
output if they are sent to the printer without being translated
into PostScript.
Also,
while most PCL printers will accept text files and do a reasonable
job of printing them
some form of initialization strings or setup may need to be done.
Finally,
you might want to try using a
<tt/MagicFilter/
that will convert just about any type of file into a PostScript file.
<sect2>Default Converter Program
<p>
This method specifies that the default file type
will be
<tt/text/.
If the simple <tt/ifhp/ type detection code cannot decide
what type of file this is,
it will invoke a converter program.
This operation is controlled by the following options.
<descrip>
<tag><tt>default_language=text</tt></tag>
When the default lanague is <tt/text/
then the
<tt/text_converter/ and
<tt/text_converter_output/ options are used.
<tag><tt>text_converter=/pathname</tt></tag>
    specifies the pathname of a text to language program.
<tag><tt>text_converter_output=language</tt></tag>
    Specifies the output language of the conversion program.
Language can be
<tt/ps/,
<tt/pcl/,
<tt/text/,
<tt/raw/,
<tt/unknown/
<tag><tt>tempfile=/pathname</tt></tag>
A temporary file location,  used to store
intermediate conversion results.
The
<tt>/pathname</tt>
value has the string
<tt>XXXXXX</tt>
appended to it and is used as input to the POSIX
<tt/mktemp()/
function.
</descrip>
<p>
The print file language is determined using the following algorithm.
<enum>
<item>
The default language is set to
<tt/unknown/
or the
<tt/default_language=language/ value if it exists.
<item>
If the command line
<tt/-c/
(binary) option is present,
or the
<tt/autodetect/ configuration option is TRUE,
then the language is set to
<tt/RAW/.
(The autodetect option is not recommended for general use).
<item>
If there is a
<tt/-Zlanguage=value/ command line option,
the language is set to
<tt/value/.
<item>
Various simple checks to determine if the file is
Postscript
(language=<tt/ps/)
or PCL
(language=<tt/pcl/)
are performed.
These are the same checks that the UNIX
<tt/file/
utility uses.
<item>
If the file type is 
<tt/text/
then the
<tt/text_converter/
program is run to translate the file and the results stored in
the <tt/tempfile/.
</enum>
<p>
One technique used with varying degrees of sophistication is to
use a general purpose file to PostScript conversion program.
These have generally been known as
<em/MagicFilters/, due to their high degree of flexibility. 
<sect2> Pseudo-MagicFilter Support
<p>
As described above,
the various
<em/MagicFilter/ packages can do conversion.
However, most of the time there is only a limited need for the
general purpose conversions.
This can be met by using the
<tt/file/ program,  which will determine the type of a file based on
its contents,
and having <tt/ifhp/ invoke a program based on the type of file found.
This method is used when
<tt/default_language=unknown/
and the
<tt>file_util_path=/path</tt>
and
<tt>file_output_match=[ ... ]</tt>
values are defined.
A typical configuration is shown below.
<tscreen>
<verb>
Configuration:
# 
#  Method 2 -
#    Use the file util and match the output
# file reports format information
#  glob text_output_format text_converter
#  - you do a glob match against pattern and use the converter
#
default_language=unknown
file_util_path=/usr/bin/file -
file_output_match = [
# glob   output converter
 *text*  ps     /usr/local/bin/a2ps -q -B -o-
 *gif*   ps     /usr/local/bin/gif2ps
 ]
</verb>
</tscreen>
<p>
The
<tt/file_output_match/
entry consists of a list of lines containing
a <it/glob/ pattern,
a language type (<tt/ps/, <tt/pcl/, or <tt/raw/),
and a program to invoke to do the conversions.
<p>
The
<tt/file/
utility is run and its output is matched against the specified
glob patterns.
When a match is found the specified program is run,
with STDIN attached to the original input file and its
STDOUT sent to the printer.
<p>
While this algorithm may appear to be overly complex, it
will handle a wide range of desired configurations.
<sect2>No Textfile Conversion Needed
<p>
If your printer can handle text files without conversion,
but require PCL intialization, then the following combination
will simply set the language to
<tt/pcl/:
<tscreen>
<verb>
text_converter@
text_converter_output=pcl
</verb>
</tscreen>
<sect2>Default Passthrough of Unknown File Types
<p>
Your printer may be capable of handling a wide variety of job
formats.  If you want to simply pass through files of
unknown type or language then use:
<tscreen>
<verb>
text_converter@
text_converter_output=raw
</verb>
</tscreen>
<sect1> Language Specific Initialization
<label id="languageinit">
<p>
After determining the output file language type,
language specific operations are then carried out by
expanding the
<it/language_/<tt/_init=[ ... ]/
options in the language context,
and then the options in the
<tt/-Toption=value/
and
<tt/-Zoption=value/
command line options.
The 
<tt/-T/
options are expanded before the
<tt/-Z/,
allowing the 
<tt/-Z/ actions to override any set by the
<tt/-T/ actions.
<p>
As mentioned elsewhere,
the reason for the language specific processing is to allow
different actions for the same command line option,
depending on the file type that is being processed.
For example,  when processing a PCL file it might be necessary to send
PCL command strings and when processing a PostScript file,
you would need to send PostScript commands.
<sect1>File Transfer and Error Status Monitoring
<label id="filetransfer">
<label id="logall">
<label id="pjl_error_codes">
<label id="pjl_quiet_codes">
<p>
If the printer can return status, i.e., the
<tt/status/
or 
<tt/forcestatus/
flag is set,
then the
<tt/ifhp/
filter will read status information back from the printer.
<p>
If the
<tt>logall</tt>
flag is SET,
then all error messages will be written to the status or log file.
<p>
If the printer is returning PJL status information,
then this has a specific format:
<tscreen>
<verb>
@PJL UINFO DEVICE
CODE=nnnn
DISLAY="value"
...

@PJL UINFO JOB
START
...

@PJL UINFO JOB
END
...

</verb>
</tscreen>
<p>
The
<tt/ifhp/ program will extract the
<tt/CODE/
and job start and end flags,
and log these as appropriate.
<p>
Unfortunately,
some PJL based printers are extremely verbose in their generation of status
messages.
In order to reduce the amount of logging of redundant information,
<tt/ifhp/
will only record when a device status has
<bf/changed/,
rather than when it has been reported.
<p>
The
pjl_quiet_codes=&lsqb; code code code &rsqb;
value is used to suppress reporting of selected error codes.
If the error code is in the pjl_quiet_codes list,  then the error status
will not be reported to the user unless the
<tt/logall/
option is set.
For example:
<tscreen>
<verb>
  pjl_quiet_codes=&lsqb; 10000 10001 10003 10023 10024 35078 &rsqb;
</verb>
</tscreen>
<p>
Also, there may be error codes which does not have a builtin error
message available.  New messages can be added using the
<tt/pjl_error_codes/
option.
Its value is a list of lines, each line consisting of an error code
followed by the corresonding error message:
<tscreen>
<verb>
pjl_error_codes=&lsqb;
   code=msg
   code=msg
   ...
&rsqb;

Example:
  pjl_error_codes=&lsqb;
     10000=powersave mode
     10001=Ready Online
     10002=Ready Offline
     10003=Warming Up
     10004=Self Test
     10005=Reset
  &rsqb;
</verb>
</tscreen>
<sect1>End of Job
<label id="waitend">
<p>
The <tt/waitend/ option controls the job termination sequence.
By default,
this will do the same work as the
<tt/sync/ operation,
and the option takes the same set of values.
<p>
If <tt/waitend/
is suppressed using <tt/waitend@/,
then as soon as a job has been transferred,
the next step,
<tt/pagecount/,
will be attempted.
If the print job has not finished at this point,
then erroneous page counts will be reported.
<p>
When using the <tt/appsocket/ protocol,
then suppressing <tt/waitend/ will cause no error messages from the printer to
be reported.
<p>
<sect1>Tektronix Phaser and AppSocket Support
<label id="appsocket">
<p>
The Tektronix Phaser PostScript printers uses the AppSocket protcol
for sending a job to the printer over a network connection.
The
<tt/appsocket/ flag enables this operation.
The protocol is (briefly):
<enum>
<item> The printer listens for UDP packets on port 9101
and for TCP/IP connections on port 9100.
<item> When a UDP packet is recieved on port 9101, then a reply
packet containing the status is returned to the originator's
address.
This packet contains an status indication,
in a <em/undefined/ format.
<item> To send a job to the printer,  a TCP/IP connection is opened to port
9100,
and a PostScript job is sent.
Only a single job can be sent at a time - a EOJ (CTRL-D)
will terminate input and flush all following jobs.
<item>
Return status will be sent in the reverse direction until the job
has completed,
at which point the connection will be closed.
</enum>
<p>
To use this protocol,
the printer TCP/IP address and port must be specified using the
<tt/-Tdev=host%port/ option;
usually port is 9100.
Also,
the printer device in the printcap entry should be <tt>lp=/dev/null</tt>.
<p>
When using the Appsocket protocol,
the <tt/ifhp/ filter will open a UDP port and use it to send
query packets to the printer UDP port 9101.
In addition,
it will try to open a connection to port 9100.
When a connection has been established,
and pagecount has been determined,
the connection will be close and reopened.
<p>
After job transfer,
the connecion will be <tt/half-closed/.
That is,
the <tt/shutdown()/ facility will be used to cause the TCP/IP connection
to be set to closed for transmission but open for reception.
The printer will send status information until the job is completed,
and then close the connection.
<p>
If page count information is needed,
the <tt/ifhp/ filter will then reopen the connection and get the page count information.
<sect> Banners and OF Mode Operations
<label id="banner">
<label id="banner_file">
<label id="page_width">
<label id="page_length">
<p>
The OF mode is enabled by the command line -Fo flag or by
the file name of the executable containing the "of" string.
<p>
When operating in the OF mode,  the filter uses the value of the
banner key to determine what to do with input.  If banners are
disabled
(<tt/banner&commat;/),
then input is simply passed directly to the
output.
The banner_suppressed flag allows you to suppress banner printing
until explicitly requested by a user using the -Zbanner flag.
<descrip>
<tag><tt>banner=pcl</tt></tag>
Uses a built-in PCL banner generator.  Pretty simple output.
<tag><tt> banner=ps </tt></tag>
Using information from the command line options,  generates
PostScript line which set the values of PostScript variables.
Then the contents of the file specified by
<tt>banner_file=/path</tt>
are appended.
<tscreen>
%!PS-Adobe-2.0 <newline>
/Seq (number) def <newline>
/Job (banner) def <newline>
/Host (HOST) def <newline>
/Class (CLASS) def <newline>
/User (USER) def <newline>
/Date (DATE) def <newline>
/Name (NAME) def <newline>
/Line (LINE) def <newline>
/<bf/X/ (<it/command line/ <tt/-X/ <it/option value/) def 
</tscreen>
<tag><tt>banner=text</tt></tag>
Puts out a simple text based banner.
Uses the command line
<tt/-w width/ and <tt/-l length/
command line options to set the page width in columns
and pagelength in lines.
If these are not set,
the configuation options
<tt/page_width=width/
and
<tt/page_length=length/
values are used.
<tag><tt>banner=/path</tt></tag>
Opens and copies the file directly to the printer.
<tag><tt> banner=|/path </tt></tag>
    Forks and EXECs the executable specified by
<tt>/path</tt>,
with the same arguments as those passed to the filter.
The executable output is sent to the printer.
</descrip>
<sect>Predefined Options
<p>
The following is a list of predefined options.
<table>
<tabular ca="ll">
<tt><ref id="appsocket" name="appsocket FLAG"></tt>
| Use Tektronix AppSocket Protocol
@
<tt><ref id="banner" name="banner=LANGUAGE"></tt>
| Enable OF banner printing using LANGUAGE
@
<tt><ref id="banner_file" name="banner_file=PATHNAME"></tt>
| PATHNAME of PostScript banner file
@
<tt><ref id="config" name="config=PATHNAMES"></tt>
| Configuration file pathnames
@
<tt><ref id="crlf" name="crlf FLAG"></tt>
| Do LF to CRLF translation
@
<tt><ref id="debug" name="debug FLAG"></tt>
| Debugging level
@
<tt><ref id="default_language" name="default_language=LANGUAGE"></tt>
| Default job file language (ps, pcl, raw, text, etc)
@
<tt><ref id="endpage" name="endpage=NNN"></tt>
| PJL JOB command END = NNN value
@
<tt><ref id="file_util_path" name="file_util_path=PATHNAME"></tt>
| Pathname of the UNIX file utility
@
<tt><ref id="forcestatus" name="forcestatus FLAG"></tt>
| Force status reading from the printer if set
@
<tt><ref id="language" name="language=LANGUAGE"></tt>
| Specify job file language to be used (ps, pcl, raw, text, etc)
@
<tt><ref id="logall" name="logall FLAG"></tt>
| Log all status reports from printer if set
@
<tt><ref id="nullpad" name="nullpad=COUNT"></tt>
| Send COUNT nulls to force full buffer condition
@
<tt><ref id="model" name="model=NAME"></tt>
| Specify model name for configuration selection
@
<tt><ref id="model_from_option" name="model_from_optin=X"></tt>
| Specify model name using a command line option value
@
<tt><ref id="no_ps_eoj" name="no_ps_eoj FLAG"></tt>
| No PostScript EOJ (CTRL-D) at start of job
@
<tt><ref id="no_pcl_eoj" name="no_pcl_eoj FLAG"></tt>
| No PCL EOJ (CTRL-D) at start of job
@
<tt><ref id="page_length" name="page_length=LINES"></tt>
| Number of lines on a text page for banner printing
@
<tt><ref id="page_width" name="page_width=COLUMNS"></tt>
| Number of columns on a text page for banner printing
@
<tt><ref id="pagecount" name="pagecount=LANGUAGE"></tt>
| Enable pagecounting using the specified lanague (pjl, ps)
@
<tt><ref id="pagecount_interval" name="pagecount_interval=SECONDS"></tt>
| Send pagecount command at SECONDS interval
@
<tt><ref id="pagecount_ps_code" name="pagecount_ps_code=STRING"></tt>
| PostScript code to get pagecount information 
@
<tt><ref id="pagecount_timeout" name="pagecount_timeout=SECONDS"></tt>
| Timeout getting pagecount after SECONDS
@
<tt><ref id="pcl" name="pcl FLAG"></tt>
| Printer supports PCL if set
@
<tt><ref id="pcl_user_opts" name="pcl_user_opts=LIST"></tt>
| User PCL options supported
@
<tt><ref id="pjl" name="pjl FLAG"></tt>
| Printer supports PJL if set
@
<tt><ref id="pjl_console" name="pjl_console FLAG"></tt>
| Printer supports messages on console
@
<tt><ref id="pjl_error_codes" name="pjl_error_codes=LIST"></tt>
| PJL error messages for error codes
@
<tt><ref id="pjl_except" name="pjl_except=LIST"></tt>
| Do not allow these PJL commands
@
<tt><ref id="pjl_init" name="pjl_init=LIST"></tt>
| PJL initializations to be done
@
<tt><ref id="pjl_job" name="pjl_job FLAG"></tt>
| PJL JOB and EOJ supported
@
<tt><ref id="pjl_only" name="pjl_only=LIST"></tt>
| Allow only these PJL commands
@
<tt><ref id="pjl_user_opts" name="pjl_user_opts=LIST"></tt>
| Allow only these user PJL commands or variables to be set
@
<tt><ref id="pjl_vars_except" name="pjl_vars_except=LIST"></tt>
| Do not allow these PJL variables to be set
@
<tt><ref id="pjl_vars_set" name="pjl_vars_set=LIST"></tt>
| Allow these PJL variables to be set
@
<tt><ref id="ps" name="ps FLAG"></tt>
| Printer supports PostScript (ps)
@
<tt><ref id="ps_user_opts" name="ps_user_opts=LIST"></tt>
| Support these PostScript user options
@
<tt><ref id="remove_ctrl" name="remove_ctrl=LIST"></tt>
| Support these characters from PostScript jobs
@
</tabular>
</table>
<table>
<tabular ca="ll">
<tt><ref id="startpage" name="startpage=NNN"></tt>
| PJL JOB command START = NNN value
@
<tt><ref id="status" name="status FLAG"></tt>
| Printer supplies status information
@
<tt><ref id="statusfile" name="statusfile=PATHNAME"></tt>
| Status file pathname
@
<tt><ref id="statusfile_max" name="statusfile_max=NNN"></tt>
| Status file has maximum size of NNN Kbytes
@
<tt><ref id="statusfile_min" name="statusfile_min=NNN"></tt>
| Status file has truncated size of NNN Kbytes
@
<tt><ref id="summaryfile" name="summaryfile=PATHNAME"></tt>
| Summary file pathname
@
<tt><ref id="sync" name="sync FLAG"></tt>
| Synchronize printer if set
@
<tt><ref id="sync_interval" name="sync_interval=SECONDS"></tt>
| Send synchronization request at SECONDS interval
@
<tt><ref id="sync_timeout" name="sync_timeout=SECONDS"></tt>
| Timeout synchronization request after SECONDS
@
<tt><ref id="tbcp" name="tbcp FLAG"></tt>
| Use Transparent Binary Communications Protocol for PostScript files
@
<tt><ref id="text" name="text FLAG"></tt>
| Printer supports text mode
@
<tt><ref id="text_converter" name="text_converter=PATHNAME"></tt>
| Pathname of text conversion program
@
<tt><ref id="text_converter_output" name="text_converter_output=LANGUAGE"></tt>
| Job language of text converter output 
@
<tt><ref id="text_tempfile" name="text_tempfile=PATHNAME"></tt>
| Temporary file pathname template 
@
<tt><ref id="trace" name="trace FLAG"></tt>
| Put error and trace messages on STDERR if set
@
</tabular>
</table>
<sect>Configuration Files
<label id="configfiles"
<p>
Run time options are provided by the
command line arguments and values in the configuration  files.
By convention,
the configuration files are named
<tt/ifhp.conf/.
<p>
In order to provide a flexible run time configuration facility,
the location of the configuration files is specifed as follows.
<enum>
<item>The default list of configuration files is:
<newline>
<tt>./ifhp.conf,/etc/ifhp.conf,./ifhp.conf</tt>
<item>
The command line option
<newline>
<tt>-Tconfig=/path,/path,...</tt>
<newline>
can be used to override the default list of configuration files.
</enum>
<p>
Here is a section of a simple configuration file.
<tscreen>
<verb>
# languages
pcl
statusfile=status
status
sync=pcl
sync_interval=20
# we force pagecounting off
#pagecount=pcl
pagecount@
&lsqb; HP4Si &rsqb;
status@
end
&lsqb; HP5Si &rsqb;
pjl
sync=pjl
</verb>
</tscreen>
<p>
The configuration file is used to set flags, option values, and to cause
various
<tt/ifhp/
actions.
The file has the following structure.
<enum>
<item>  Blank lines and lines starting with # are ignored.
<item>  Keys or flags start in column 1.
The syntax is similar to the LPRng and BSD
<tt/printcap/
file.
<tabular ca="lll">
Syntax|
Equivalent To|
Class
@
flag|
flag=1|
FLAG
@
flag&commat;|
flag=0|
FLAG
@
flag=val|
flag=val (string value)|
STRING
@
flag#val|
flag=val (string value)|
STRING
@
flag=&rsqb; v v  ... &lsqb; |
|
LIST
@
(no flag name present)|
flag=0|
FLAG
@
</tabular>
<item>
Flags are used for options which take a TRUE/FALSE, 0/1, or ON/OFF
value, and
<tt/ifhp/
will substitute the appropriate form or perform the
assocated action if the flag is TRUE.
<item>
Strings are used to set options which require a multicharacter value.
The special form
<tt/flag&commat;/
is used to indicate that the operation
related to this option is not to be performed.
<item>
Lists are used to specify a list of options which can be flags or string
values.
Lists have the property of
<em/recursive evaluation/
which means that the individual items in the list will be acted upon in order.
This is discussed later in detail.
<item>
The list entries are separated by whitespace,
and each entry can have the form v, v&commat;,
v=word, or v1#word, where word does not contain whitespace or
the &lsqb;&rsqb characters.
<item>
Flag values can be spread over multiple lines.  Lines starting with
whitespace, are treated as a continuation of the previous
flags line value.  For example:
<tscreen>
<verb>
# set string x value 'first\n  second\n  third'
x= first
  second
  third
# set list y value &lsqb; f1 f2 &rsqb;
y=&lsqb; f1
 f2 &rsqb;
</verb>
</tscreen>
<item>Selection lines have the form:
<tscreen>
<verb>
&lsqb; glob glob ... &rsqb;
</verb>
</tscreen>
<p>
    Selection lines divide the configuration file into sections
    corresponding to a particular printer model.   Configuration
    information is extracted from a file until either an 'end' line
    or a selection line is encountered.
<item>
    An 'end' line consisting of the single work 'end' will terminate
    reading lines from a configuration file.
<item> As the configuration file is read,  flag lines and values are accumulated.
Later values encountered in the file will replace earlier values.
</enum>
<sect1> Configuration Selection
<p>
The recommended format for a  configuration file is to put common
(default) flag settings at the start of the configuration file,
followed by selection sections with overridding and additional flag
values.
<p>
To allow a single file to be used for multiple printer configurations,
you can specify that a section of the file is to be used ONLY by
a various models of printers.  This is is controlled by the value
of the 'model' flag and selection lines of the form:
<tscreen>
<verb>
  &lsqb; glob glob ... &rsqb;
</verb>
</tscreen>
<p>
The first occurrence of a 'model=xx' line in either the -T options
or the configuration file will set the model flag value to 'xx'.
<p>
The 'model' value is matched against the modelglob values using
GLOB matching.  For example:
<tscreen>
<verb>
hp*      matches hp4 hp5x
hp&lsqb;45&rsqb;   matches hp4 hp5, but not hp5x
hp&lsqb;3-6&rsqb;* matches hp3, hp5, hp5x, but not hpiii
</verb>
</tscreen>
<p>
If a matching entry is found,  successive lines will be used until
either another selection line or an 'end' line is encountered.  An
'end' line will terminate reading the current file, and the next
configuration file will be read.
<p>
The default list of configuration files is:
<tscreen>
<verb>
ifhp.conf, /etc/ifhp.conf, ifhp.conf
</verb>
</tscreen>
<p>
This arrangement allows you to read the ifhp.conf file to get
various model settings,  scan the /etc/ifhp.conf file to get the
generic ones,  and then to rescan the local ifhp.conf file to
provide overrides to values set in the /etc/ifhp.conf file.
<sect1> Option Use
<p>
Options and their values are used to control printer operation.
There are two types of options:
those with a predefined or
<em/builtin/
meaning to the
<tt/ifhp/
filter and those which
are simply used to supply values for expansion during operation.
<p>
The builtin options are listed in later sections,
and their use is explained.
These options can have flag, string, or list values as is appropriate
to their corresponding actions.
<sect1>Recursive List Expansion
<p>
During normal operation,
the
<tt/ifhp/
filter will perform an operation by producing a set of strings
which will be sent to the printer or output device.
These strings may be obtained by using the values of predefined or builtin
option names,
or by expanding a LIST value.
<p>
A LIST value has the form X=&lsqb; v1 v2 ... &rsqb;.
When a list value is expanded
each of v1, v2 is examined in turn
and the corresponding action or string substitution or builtin evaluation
is carried out.
If v1 has a string value and is not recognized as a builtin or special option
then normally the string value will be used.
<tscreen>
<verb>
t1=[ p1 p2 p3=end ]
p1=this is
p2=[ p3 p4 ]
p3=a
p4=test
p3=living\020\%{p3}
</verb>
</tscreen>
<p>
For example,
when expanding
<tt/t1/
each of
<tt/p1/
and
<tt/p1/
is in turn expanded.
This will produce the strings
<tt/"this is"/,
<tt/"a"/,
<tt/"test"/
and
<tt/"living end"/
in turn.
<p>
Some LIST variables are used in
printer language specific contexts
and their values are processed appropriately.
For example,
pjl_init=&lsqb;...&rsqb; specifies a set of operations to be carried
out for printers that support PJL,
and pcl_init=&lsqb;...&rsqb; for PCL
printers.  The expansion of the LIST entries is done in the language
specific context.
For PJL this requires that the output be well formed PJL commands,
and for PCL that all whitespace be removed.
<p>
The context dependent expansion is required because sometimes it
is necessary to do operations both using PJL and PCL or PJL and PS
combinations to ensure correct printer operation.
For this reason,  during expansion the language name and an underscore
is prefixed to the list entry name,  and this is used as the option name during the search.
<p>
For example,  suppose that we have:
<tscreen>
<verb>
    pjl_init=&lsqb; test &rsqb;
    pcl_init=&lsqb; test &rsqb;
    initstr=NO
    pjl_initstr=&commat;PJL ECHO YES
    pcl_initstr=\033(*yeS
</verb>
</tscreen>
<p>
When PJL initialization is done, the 'pjl_test' LIST will be
expanded, and the PJL string '&commat;PJL ECHO YES' will obtained.
When PCL language specific processing is done,  then the
\033(*yeS string will be obtained.
<sect1>String Expansion
<p>
String values are encoded using a
simple PERL/C language like method.  The \ (escape) character
introduces a replacement string.  This has the form:
<descrip>
<tag/Standard Character Replacement/
<tt/ \f \r \n \t \nnn/
where nnn are 3 octal digits are replaced
by the standard PERL or C character substutions.
<tag/Option Value Replacement/
<tt/\%format{option}    \%format[option]/
<p>
The option name will be relaced by the formatted option value.
<tag/Option Search Order/
The option value is located using a simple set of rules.
<enum>
<item>
During a recursive option evaluation,
expanding
<tt/option=word/
will push the
<tt/option=word/
combination onto an evaluation stack.
This stack is searched in oldest to newest order for a match.
<item>
If no match was found,
and the expression has the form
<tt/{option}/
then the
<tt/-Zoption=value/
command line options will be searched for a match.
<item>
If no match was found,
then the
<tt/-Toption=value/
command line options will be searched for a match.
This allows the 
<tt/{option}/
to start searching from the -Z command line options and
<tt/[option]/
to start searching from the -T command line options.
<item>
If no match was found,
then the configuration information is searched.
<item>
If no match was found,
then the value is considered undefined,
and a 
<tt/"0"/
value is used.
</enum>
<tag/Format/
The format specifies how the value is to appear,
and is similar to the printf format usage:
<tscreen>
<verb>
   %&lsqb;-&rsqb;&lsqb;0&rsqb;&lsqb;length&lsqb;.precision&rsqb;&rsqb;&lsqb;format&rsqb;
</verb>
</tscreen>
<p>
The default format is %d, ie, \%{val} would be \%d{val}.
The numerical formats supported are: %d, %o, %x, %X, %e, %f, and %g;
The %s format use the option string value.
<p>
The format is usually not required, except when fractional values of point sizes
or string substition rather than numerical substition is required.
</descrip>
<p>
For example:
<tscreen>
<verb>
Configuration:
  pjl_user_opts=[ ... outbin intray ...]
  pjl_outbin=@PJL SET OUTBIN=\%s{outbin}
  intraynum=4
  pjl_intray=@PJL SET INTRAY=\%{intraynum}

Command:
  ifhp -Zoutbin=LEFT
</verb>
</tscreen>
<p>
During PJL language processing,
the 
<tt/-Z/
command line options
will be scanned for options which appear in the
<tt/pjl_user_opts/
list.
The
<tt/-Toutbin=LEFT/
option will be found and will be expanded in the PJL context
by prefixing
<tt/pjl_/
and looking for a string or list value.
The
<tt/pjl_outbin/
option will be found,
and the
<tt/@PJL SET OUTBIN=\%s{outbin}/
string will be expanded.
<p>
Now we need to search for the
<tt/outbin/
value.
We first search for it on the evaluation stack,
but there is nothing there yet.
We then search the
<tt/-Z/
options and find the
<tt/outbin/
value,
and substition yields
<tt/@PJL SET OUTBIN=LEFT/.
<p>
Next, the
<tt/intray/
option is found and
<tt/pjl_intray/
is expanded,
which needs a value for
<tt/intraynum/.
This is found in the configuration information,
and finally in
<tt/@PJL SET INTRAY=4/.
<tscreen>
<verb>
cpi=5.5
pcl_cpi=\033\%3.2f{cpi}D
</verb>
</tscreen>
<p>
During PCL option expansion,
we might need to expand the
<tt/pcl_cpi/
option.
When the
<tt/pcl_cpi=\033\%3.2f{cpi}D/
string is expanded,
the result is
<tt/\033\%5.00D/.
If the user has specified
<tt/-Tcpi=9/
on the command line then the result is
<tt/\033\%9.00D/.
<sect1>Language Context
<p>
The Tifhp filter sends initialization and configuration commands to the
printer.
Depending on the language,
these commands have specific forms and requirements.
Rather than requiring the user to remember the details, Tifhp uses the following conventions.
<sect2>PJL Language
<p>
A PJL command has the form
<tt/@PJL OPCODE .../.
A command must start with
<tt/@PJL/
and consist of a single string value.
You cannot patch together options to make a single PJL command.
<enum>
<item>
Before sending any PJL command to the printer,
the PJL Universal Exit Command
(<tt/\033%-12345X/)
string is sent to the printer.
<item>
Because not all printers support all PJL commands,
the Tifhp filter performs a couple of checks using the
<tt/pjl_only/
and
<tt/pjl_except/
configuration options.
The OPCODE must appear in the
<tt/pjl_only/
list and not in the
<tt/pjl_except/
list.
<item>
Leading and trailing whitespace is removed,
and all characters are converted to uppercase.
<item>
Individual commands have a newline
(<tt/\n/) appended to them before being sent to the printer.
</enum>
<sect2>PCL Lanaguage
<p>
When sending PCL initialization strings to a printer,
it is essential to send nothing that could cause a printable character to
be sent before the actual file contents.
Such output could cause the location and positioning of text to be altered
in unexpected ways.
To avoid this,
the following steps are taken when processing PCL strings.
<enum>
<item>
Before any PCL string is sent to the printer,
the PCL End of Job
(<tt/\033E/) string is sent to the printer.
<item>
First,
all whitespace (blanks, tabs, etc) are removed from the string value.
<item>
Next, all escaped values are substituted.
At this point you can
<em/force/
printable strings containing whitespace into the output by using the
<tt/\nnn/
escape mechanism.
</enum>
<sect2>PostScript Language
<p>
The PostScript language processing is very minimal,
as there are few problems sending PostScript to a printer.
<enum>
<item>
Before sending any PostScript initialization strings,
the PostScript End of Job indicator
(<tt/\004/ or Control-D) is sent.
<item>
Strings are then expanded and the escape sequences are substituted.
<item>
Individual strings have a newline
(<tt/\n/) appended to them before being sent to the printer.
</enum>
<sect> Font Download Support
<p>
For historical reasons,
there is support for downloading a font or other file to the
printer.
A large amount of the necessary operations are now in the
<tt/ifhp.conf/
file.
<p>
The
<tt/font_download/
built-in option supports downloading as described below.
<sect1> PCL Font Downloading
<p>
The following shows the a typical
<tt/ifhp.conf/
file which has PCL font downloading enabled.
<tscreen>
<verb>
#
# Fonts and Font Downloading
#  fontid is used to set the current font
pcl_init=[ ... font ... ]

# combination command
pcl_font=[ delete_fonts font_id font_download font_primary ]

# font control
#
font_op=0
pcl_font_op=\033*c\%{font_op}F
pcl_delete_fonts=\033*c0F

font_id=1
pcl_font_id=\033*c\%{font_id}D

# set primary font
font_primary=1
pcl_font_primary=\033(\%{font_primary}X

# font directory
pcl_fontdir=/usr/local/lib/fonts

#default font file
font=c1201b.10

</verb>
</tscreen>
<p>
To allow users to download a font and have it set up for PCL use,
the 
<tt/pcl_init/
option should include the
<tt/font/
option in an appropriate position in the intitialization sequence.
As shown above,
this will get expanded into the
<tt/pcl_delete_fonts/,
<tt/pcl_font_id/,
<tt/pcl_font_download/ (which is has built-in support),
and the
<tt/pcl_font_primary/
options,
which are expanded in order.
<p>
The
<tt/pcl_font_download/ is supported by the builtin operation which will
find the
<tt/pcl_fontdir/
directory value
and a value for the
<tt/font/
variable,
using values from the
<tt/-Z/
and
<tt/-T/
and configuration information in that order.
If no
<tt/font/
value is found,
no font will be downloaded.
For example:
<tscreen>
<verb>
lpr -Tfont=font1,font2
</verb>
</tscreen>
<p>
When the
<tt/pcl_font_download/
option is expanded,
it will generate the pathnames
<tt>/usr/local/lib/fonts/font1</tt>
and
<tt>/usr/local/lib/fonts/font2</tt>,
open these files,
and send their contents directly to the printer.
<sect1> PS Font Downloading
<p>
PostScript font downloading is supported in a similar manner to
PCL font downloading.
<tscreen>
<verb>
#
# Fonts and Font Downloading
# 
ps_init=[ ... font ... ]

# combination command
pcl_font=[ font_download ]

# font directory
ps_fontdir=/usr/local/lib/fonts

#default font file
font=font.ps.10
</verb>
</tscreen>
<p>
In a similar manner to the PCL font downloading,
when the
<tt/ps_init/
list is expanded,
the
<tt/ps_font/
entry will be expanded in turn.
If the <tt/-Zfont=ZapDingbat.ps/ is specified,
then the
<tt>/usr/local/lib/fonts/ZapDingbat.sp</tt>
file will be opened and downloaded to the printer.
<sect1> PJL File Downloading
<p>
In a similar manner to the above font downloading,
you can specify a configuration or other setup file that should be
sent to the printer as part of the PJL setups.
The following configuration shows how to set this up.
<tscreen>
<verb>
#
# PJL Initialization File Downloading
#  fontid is used to set the current font
pjl_init=[ ... setup  ... ]

setup=initval
font=\%s{setup}
# setup directory
pjl_fontdir=/usr/local/lib/fonts
pjl_setup=[ font_download ]
</verb>
</tscreen>
<p>
The above configuration will cause the value of the
<tt/setup/
<tt/-Z/,
<tt/-T/
or configuration option to be used.
<sect>Banner Printing
<p>
One of the more difficult administrative issues is whether to print
banners (job separators) or to save the large amount of wasted
paper, time and effort.
The LPRng and
<tt/ifhp/
combination provide a rather esoteric set of methods to generate banners,
at least one of which should be suitable for your application.
<p>
You should be aware that some printers have the obnoxious habit of
generating their own banner pages when jobs are transferred via
the RFC1179 protocol.
You should consult the manufacturers documentation and take the
necessary steps to turn printer banner page generation off.
<sect1> Banner Printing with LPRng
<p>
The following steps need to be done to configure LPRng to print
banners using
<tt/ifhp/.
<enum>
<item>
In order to print a banner,
the LPRng print spooler will require a user name
for the banner page to be present in the print job.
However,
since users can request
<it/no banner/
via various options on the print spooler interface,
LPRng provides the handy
<it/force_banner/
option to always force a banner to be generated,
even if the user has specifically requested that one
<it/not/
be generated.
This is useful for preventing the
<it/disappearing print job/
syndrome in large installations.
<item>
Next,
LPRng must be configured to generate banners.
The
<tt/sh/
(suppress header)
option must be off
(<tt/sh@/).
<item>
At this point you need to decide if you want LPRng to generate
the banner of the
<tt/ifhp/
filter to generate the banner.
If you want LPRng to generate the banner,
you can specify a
<tt/banner/
generation program,
and inform
<tt/ifhp/
<bf/not/
to generate a banner (the default).
<tscreen>
<verb>
Printcap:
lp:
&nbsp;&nbsp;:sh@
&nbsp;&nbsp;:banner=/usr/local/filters/bannergen
&nbsp;&nbsp;:if=ifhp&nbsp;-Tbanner
</verb>
</tscreen>
<item>
If you want
<tt/ifhp/
to generate a banner,
you do not have LPRng generate a banner and
enable banner printing by
<tt/ifhp/.
You also can specify the
<tt/sb/
or short banner option,
which will cause a very short dummy banner to be generated.
This will be ignored by the
<tt/ifhp/
filter.
<tscreen>
<verb>
Printcap:
lp:
&nbsp;&nbsp;# short banner, save effort
&nbsp;&nbsp;:sh@:sb
&nbsp;&nbsp;:if=ifhp -Tbanner
</verb>
</tscreen>
<item>
Finally,
you have your choice of PCL,
PostScript and even Text banners.
These can be specified using
<tt/banner=/<bf/language/:
<tscreen>
Printcap:
lp: <newline>
&nbsp;&nbsp;# short banner, save effort <newline>
&nbsp;&nbsp;:sh@:sb <newline>
&nbsp;&nbsp;:if=ifhp -Tbanner=<bf/language/ <newline>
</tscreen>
</enum>
<sect1> Stand Alone Banner Program
<p>
Occasionally it is useful to be able to generate a banner
in
<it/standalone/
mode.
For example,
you might want to generate a banner
when using an LPRng
<it/bounce queue/
to perform filtering operations before forwarding jobs to another
printer.
To do this requires a stand-alone banner printer.
<tt/ifhp/ can be configured to do this by using:
<tscreen>
ifhp -Tbanner_only
</tscreen>
In addition,
you can specify the type of banner you want using:
<tscreen>
ifhp -Tbanner_only=<bf/language/
</tscreen>
<p>
Lastly,
in order to be <it/vintage software compatible/,
if the ifhp program is invoked as the
<tt/banner/
program,
this is effectivly the same as
<tscreen>
ifhp -Tbanner_only
</tscreen>
<p>
For example,
to use this with a bounce queue to an
<tt/hp4/ printer,
the following printcap entry might be used:
<tscreen>
<verb>
# for clients, force spooling to server
lp:lp=lp@server
# server
lp:server
  :bq=raw@printer
  :ifhp=model=hp4
  :generate_banner
  :banner=/usr/local/filters/ifhp -Tbanner_only
  :if=/usrlocal/filters/ifhp
  :of=/usrlocal/filters/ifhp
</verb>
</tscreen>
<sect> Accounting
<p>
In Academic institutions, avoiding printing accounting has been
regarded as a challenge,  an ongoing game of fat cat and poor starving
mouse, between the Adminstration and the downtrodden, poor, overcharged
student.  The following is a lighthearted ramble down the dark lane of
printing accounting.
<p>
We will disregard the fact that if most students put as much effort
into their studies as in finding ways to avoid accounting procedures
then they would be Rhodes Scholar material,  but I digress...
<sect1>Page Accounting Algorithm
<p>
The accounting procedures put into the LPRng and the ifhp filters may
appear to be extraordinarily complex,  but believe me, they are not.
Firstly, we make the assumption that the printer has some sort of
non-volatile page counter mechanism that is reliable and impervious to
power on/off cycles.  Without this mechanism the enterprising student
ummm... user will simply turn off the printer.  Software that prescans
jobs for line counts and pages is notoriously unreliable,  given even
the most modest efforts of users to hide these procedures.   The cost
of running a PostScript simulator simply to do accounting has its
flaws; without ensuring that the simulator has all of the interesting
security loopholes closed, such as opening files, etc.,  it can become
a trap door to hell for the system administrator.
<p>
Secondly,  we must make the assumption that the student... uhhh...
user will not be able to tinker with the page counter mechanism, i.e.-
they will not be able to roll back the odometer on the printer,
<it/for the duration of a single job/.
I will digress and point out that a student
actually did this for a challenge;  it only took him a couple of weeks
of study and a fully equipped microcontroller lab, and two (2) laser
printers which he ruined in the experiment.
HP was not amused when we
sent them back under warranty,  claiming that this our 'normal lab usage.'
<p>
Lastly,  you should not mind a small amount of pilferage, or a few
pages here and there being charged to the wrong account.
<p>
The basic mechanism the ifhp filter uses is to record the page
counter value at the start and end of each part of a print job. Each
record has the form:
<tscreen>
<verb>
start -qpagecounter ....
end  -ppages -qpagecounter -telapasedtime ....
</verb>
</tscreen>
<p>
When we use the OF filter and/or banners,  we will see the
individual jobs bracketed by the OF filter records:
<tscreen>
<verb>
start -q100 -Fo -kcfA100taco -uuser -hhost -R...  
start -q101 -Ff -kcfA100taco -uuser -hhost -R...  
end  -p1 -q102 -Ff -kcfA100taco -uuser -hhost -R...  
start -q102 -Ff -kcfA100taco -uuser -hhost -R...
end  -p3 -q105 -Ff -kcfA100taco -uuser -hhost -R...  
end  -p5 -q105 -Fo -kcfA100taco -uuser -hhost -R...
</verb>
</tscreen>
<p>
It should be clear from the above that all we need to do is to add up
the values for the -Fo (OF) filter lines and we are done.
<p>
Unfortunately,  this is too simplistic.  If for some reason the job is
killed or terminates due to error conditions,  the OF filter may not
get to finish its work.  Thus,  we may see the following:
<tscreen>
<verb>
start -q100 -Fo -kcfA100taco -uuser -hhost -R...  
start -q101 -Ff -kcfA100taco -uuser -hhost -R...  
start -q110 -Fo -kcfA101taco -uuser -hhost -R...
</verb>
</tscreen>
<p>
This is a clear indication that the user's job has been terminated.  In
this case we need to use the differences between pagecounters of the start
records to do accounting.
<p>
There is a caveat to all of this;  that is the problem of the last dead
job in the list.  If the last line in the accounting file is:
<tscreen>
<verb>
start -q110 -Fo -kcfA101taco -uuser -hhost -R...
</verb>
</tscreen>
is the last job finished or did it abort?
<sect1> You Used 2000 Pages, Out of Quota
<p>
Now we move on to the problem of real time accounting.  Due to limited
budgets, etc., many institutions would like to strictly enforce limits
on paper use by students. As jobs are printed their accounts should be
docked for the amount of paper use.  One way to do this is to have an
external accounting procedure update a shared database.  The
ifhp
filter
has provision for a shell script to be invoked
at the start and end of print job;
this is done by both the OF and IF filter.  Thus, we can blithely
assume that there is a central database carefully getting updates
from the LPRng software, probaly from dozens of different printers,
and updating the accounting information,
and that this program can query the database,
check limits,
and terminate printing if the limits are exceeded.
<p>
The first question to be asked is simple:  is this worth it?
Perhaps doing accounting as a batch job once an hour/four times
a day/once a day is cheaper than buiding an running such a database.
If it costs $5K/year for the database software, you might just consider
ignorng the 10,000 pages that get lost in the shuffle and use
a simple set of awk/sed/perl scripts to update a database once
an hour.
<sect1> Bad Jobs - Who Do We Bill?
<p>
We inevitably run into an interesting question:
  what happens if a job does not complete correctly?
<p>
If you use the completion of the OF filter as a success status, I have
to point out that many students... ummm... users soon find ways to send
jobs to the printer that will cause it to lock up after their output
has been printed. These jobs require power cycling of the printer and
restarting the filter; a bit extreme, perhaps, but it has happened.
<p>
I suggest that you simply adopt a 'bill to last user of record'
attitude,  using the pagecount information as follows:
<tscreen>
<verb>
start OF -- starting point for THIS job
start IF --  nice information, but not useful
start IF --
end OF -- ending point for this job - can record infomaiton

start OF --
if no end OF for previous job,  then treat as end OF and
	  update accounting.
</verb>
</tscreen>
<p>
Now somebody is sure to complain that they got charged for a bunch of
pages that they did not use.  This is inevitable;  always carry a
can of oil for the squeaky wheels.  I might make the observation that
once is accident, twice is coincidence, but three times is malice;
be wary of the constant complainer and check out not only him but
also his co-workers.
<sect1> How Do We Update The Database
<p>
I suggest that database update be done as follows:
maintain a 'last page reported' record for each printer in the
database.

When a successful job reports in,  check to see that the recorded pagecount
for the printer is in agreement with the one that is reported.

If this is not the case then you have had some unsuccessful jobs.
In this case I strongly recommend that you have a means to request the
accounting reporting program to go back through the accounting file and
find the last report for the page counter value and try to backtrack
through the accounting files.  The accounting file is one of the first
things to be attacked by students... Ummm...  users.  It should NOT be
kept on and NFS exported or mounted file system.  It should be
carefully pruned and copied, perhaps on an hourly basis.

Now some adminstrators have fallen in love with network based printers;
do not believe ANYTHING that comes over a network connection without
some form of authentication;  PGP has some very nice Public Key
mechansims for handling this.  This is a major weakness in using a
database for keeping track of accounting - a weak authentication
mechanism may lead to denial of service attacks by students flooding
the database with bogus print usage reports;  suddenly NOBODY can print
and the adminstrator is driven to turning off accounting.

Good luck.  I am never suprised when I encounter yet another wrinkle in
this area.
<sect1> Accounting Shell Script
<p>
The 
<tscreen>
<verb>
accounting=/pathname
</verb>
</tscreen>
specifies a program to run
at the start and end of the
<tt/ifhp/ activity.
For an example of a simple script,
see the accounting.sh script in the distribution.
<sect1> Pagecounter Values
<p>
The only reliable way to do page counting in the face of
PostScript,
PCL,
and other mystical printer job languages is to query the printer
and get the current value of a hardware page counter.
Unfortuately,
this may not be a trivial matter.
<enum>
<item>
The page counter may not be updated in real time.
This means that you may need to wait a couple of seconds until you are
sure that the pages have been recorded.
Usually this occurs when the pages leave the print engine
and are put in the output tray.
<item>
Printers do job batching,
and when they report job completion the job is still being printed.
<item>
Some printers report
<it/impressions/,
i.e.- sides of pages printed,
rather than pages.
If you are doing duplex printing then you may find that your
paper count and your page (impression) count differ.
<item>
Some printers simply lack page reporting.
</enum>
<p>
Given these problems,
it is more than reasonable to reconsider the need for accounting,
or to work closely with the printer vendor to understand the
interactions of print jobs and reporting of page counts.
<sect> Monitoring Printer Operation
<p>
Normally the
<tt/ifhp/
filter will write error and trace messages to the
<tt/statusfile/
specified by the command line
<tt/-s/
option or the
<tt/statusfile=pathname/
configuration entry.
<p>
However,
there may be a need to get information sent to a central or other
location for system administration purposes.
The
<tt/summaryfile=host%port/
option will cause <tt/ifhp/ to  open a UDP connection 
to the specified port on the remote host and send the error and
trace information to that location as well.
<p>
The
<tt/monitor/
program include in the LPRng
and <tt/ifhp/
distributions is a template for writing a program to use
this information.
<sect> HP JetDirect Card Support
<p>
The  HPJetDirect  card or external
JetDirect box can  be configured through the printer front
panel  or through a set of network files.  Here is a summary
of  the  methods  used  from  UNIX  systems, or when you are
desperate, to configure the printer.
<sect1>TCP/IP Network Address
<p>
You can set the network address from the front panel.
Reset  the printer; use the MENU, +-, SELECT keys as follows:
<tscreen>
<verb>
 MENU  -> MIO MENU (use MENU to display MIO MENU)
 ITEM  -> CFG NETWORK=NO*
 +     -> CFG NETWORK=YES
 ENTER -> CFG NETWORK=YES*
 ITEM  -> TCP/IP=OFF* (use ITEM to display TCP/IP)
 +     -> TCP/IP=ON
 ENTER -> TCP/IP=ON*
 ITEM  -> CFG TCP/IP=NO* (use ITEM to display TCP/IP)
 +     -> CFG TCP/IP=YES
 ENTER -> CFG TCP/IP=YES*
 ITEM  -> BOOTP=NO*
	 (Enable BOOTP if you want to - see below)
 ITEM  -> IP BYTE 1=0*
	 This is IP address MSB byte.
	 Use +- keys to change value, and then ENTER to change
	 Use ITEM keys to get IP BYTE=2,3,4
 ITEM  -> SM BYTE 1=255*
	  This is the subnet mask value
	 Use +- keys to change value, and then ENTER to change
	 Use ITEM keys to get IP BYTE=2,3,4
 ITEM  -> LG BYTE 1=255*
	 This is the Syslog server (LoGger) IP address
	 Use +- keys to change value, and then ENTER to change
	 Use ITEM keys to get IP BYTE=2,3,4
 ITEM  -> GW BYTE 1=255*
	 This is the subnet gateway (router) IP address
	 Use +- keys to change value, and then ENTER to change
	 Use ITEM keys to get IP BYTE=2,3,4
 ITEM  -> TIMEOUT=90
	  This is the connection timeout value.  It puts a limit
	 on time between connections.  A value of 10 is reasonable.
</verb>
</tscreen>
<sect1> BOOTP Information
<p>
If  you have a bootp server, you can put this information
in  the  bootptab  file.   To  use this, you must enable the
bootp  option  on  the printer.  The T144 option specifies a
file to be read from the bootp server.  This file is read by
using  the  TFTP  protocol, and you must have a TFTPD server
enabled.  Here is a sample bootptab entry.
<tscreen>
<verb>
# Example /etc/bootptab: database for bootp server (/etc/bootpd).
# Blank lines and lines beginning with '#' are ignored.
#
# Legend:
#
#       first field -- hostname
#                       (may be full domain name)
#
#       hd -- home directory
#       bf -- bootfile
#       cs -- cookie servers
#       ds -- domain name servers
#       gw -- gateways
#       ha -- hardware address
#       ht -- hardware type
#       im -- impress servers
#       ip -- host IP address
#       lg -- log servers
#       lp -- LPR servers
#       ns -- IEN-116 name servers
#       rl -- resource location protocol servers
#       sm -- subnet mask
#       tc -- template host (points to similar host entry)
#       to -- time offset (seconds)
#       ts -- time servers
#
# Be careful about including backslashes where they're needed.  Weird (bad)
# things can happen when a backslash is omitted where one is intended.
#
peripheral1:
:hn:ht=ether:vm=rfc1048:
:ha=08000903212F:
:ip=190.40.101.22:
:sm=255.255.255.0:
:gw=190.40.101.1:
:lg=190.40.101.3:
:T144="hpnp/peripheral1.cfg":
</verb>
</tscreen>
<p>
If  you  are  using the T144 option, you will need to create
the  configuration file.  The sample configuration file from
the HP Direct distribution is included below.
<tscreen>
<verb>
#
# Example HP Network Peripheral Interface configuration file
# 
# Comments begin with '#' and end at the end of the line.
# Blank lines are ignored.  Entries cannot span lines.

# Name is the peripheral (or node) name.  It is displayed on the peripheral's
# self-test page or configuration plot, and when sysName is obtained through
# SNMP.  This name can be provided in the BOOTP response or can be specified
# in the NPI configuration file to prevent the BOOTP response from overflowing
# the packet.  The domain portion of the name is not necessary because the
# peripheral does not perform Domain Name System (DNS) searches.  Name is
# limited to 64 characters.

name: picasso

# Location describes the physical location of the peripheral.  This is the
# value used by the interface for the MIB-II sysLocation object.  The default
# location is undefined.  Only printable ASCII characters are allowed.
# Maximum length is 64 characters.

location: 1st floor, south wall

# Contact is the name of the person who administers or services the peripheral
# and may include how to contact this person.  It is limited to 64 characters.
# This is the value used by the interface for the MIB-II sysContact object.
# The default contact is undefined.  Only printable ASCII characters are
# allowed.  Maximum length is 64 characters.

contact: Phil, ext 1234

# The host access list contains the list of hosts or networks of hosts
# that are allowed to connect to the peripheral.  The format is
# "allow: netnum [mask]", where netnum is a network number or a host IP
# address.  Mask is an address mask of bits to apply to the network number
# and connecting host's IP address to verify access to the peripheral.
# The mask usually matches the network or subnet mask, but this is not
# required.  If netnum is a host IP address, the mask 255.255.255.255 can
# be omitted.  Up to ten access list entries are permitted.

# to allow all of network 10 to access the peripheral:
allow: 10.0.0.0  255.0.0.0

# to allow a single host without specifying the mask:
allow: 15.1.2.3

# Idle timeout is the time (in seconds) after which an idle
# print data connection is closed.  A value of zero disables
# the timeout mechanism.  The default timeout is 90 seconds.

idle-timeout: 120

# A community name is a password that allows SNMP access to MIB values on
# the network peripheral.  Community names are not highly secure; they are
# not encrypted across the network.  The get community name determines which
# SNMP GetRequests are responded to.  By default, the network peripheral
# responds to all GetRequests.  The get community name is limited to 32
# characters.
#
# For hpnpstat and hpnpadmin, the community name can be stored in
# /usr/lib/hpnp/hpnpsnmp.

get-community-name: blue

# The set community name is similar to the get community name.  The set
# community name determines which SNMP SetRequests are responded to.  In
# addition, SetRequests are only honored if the sending host is on the
# host access list.  By default, the network peripheral does not respond
# to any SetRequests.  The set community name is limited to 32 characters.
#
# The set community name can come from /usr/lib/hpnp/hpnpsnmp
# if it is the same as the get community name.  We recommend that the
# set community name be different from the get community name though.

set-community-name: yellow

# SNMP traps are asynchronous notifications of some event that has occurred.
# SNMP traps are useful only with network management software.  Traps are
# sent to specific hosts and include a trap community name.  Up to four
# hosts can be sent SNMP traps.   The trap community name is limited to
# 32 characters.  The default name is public.

trap-community-name: red

# The SNMP trap destination list specifies systems to which SNMP
# traps are sent.  Up to four IP addresses are allowed.  If no
# trap destinations are listed, traps are not sent.

trap-dest: 15.1.2.3
trap-dest: 15.2.3.4

# The SNMP authentication trap parameter enables or disables the sending
# of SNMP authentication traps.  Authentication traps indicate that an SNMP
# request was received and the community name check failed.  By default,
# the parameter is off.

authentication-trap: on

# The syslog-facility parameter sets the source facility identifier that the
# card uses when issuing syslog messages.  Other facilities, for example,
# include the kernel (LOG_KERN), the mail system (LOG_MAIL), and the spooling
# system (LOG_LPR).  The card only allows its syslog facility to be configured
# to one of the local user values (LOG_LOCAL0 through LOG_LOCAL7).  The
# selectable option strings, local0 through local7 (configured to LOG_LOCAL0
# through LOG_LOCAL7, respectively) are case insensitive.  The default
# syslog-facility for the card is LOG_LPR.

syslog-facility: local2

# This parameter allows the card to treat hosts on other subnets as if the
# hosts were on the card's subnet.  This parameter determines the TCP
# Maximum Segment Size (MSS) advertised by the card to hosts on other subnets
# and affects the card's initial receive-window size.  The card will use a
# TCP MSS of 1460 bytes for local hosts, and 536 bytes for a non-local host.
# The default is off, that is, the card will use the maximum packet sizes
# only on the card's configured subnet.
#
# The configuration utility does not allow access to this parameter.  If you
# want to configure it, you must manually edit the NPI configuration file
# and add it to the bottom of the entry for the network peripheral.

subnets-local: on

# This parameter affects how the card handles TCP connection requests from
# the host.  By default, the JetDirect MPS card will accept a TCP connection
# even if the peripheral is off-line.  If this parameter is set to "on", then
# the card will only accept a TCP connection when the peripheral is on-line.

old-idle-mode: off

</verb>
</tscreen>
<sect1> Timeouts
<p>
You should be aware that the
<tt/idle-timeout/
value in the configuration file will override the value
entered on the control panel of the printer.
<p>
Also,
the
<tt/@PJL SET TIMEOUT = NNN/
command will override this value as well.
<!-- IFHP-HOWTO SGML format -->
</article>
